# Руководство по развертыванию: Ладога. МТ. Транзитные заказы

## Обзор развертывания

### Цель развертывания
Развернуть функциональность транзитных заказов в продуктивном окружении, обеспечив стабильную работу и интеграцию с 1С.

### Компоненты для развертывания
- **Мобильный терминал**: Обновленная версия с новой функциональностью
- **Чикаго**: Настроенная интеграция с 1С
- **1С**: Конфигурация для приема новых параметров
- **База данных**: Обновления схемы и данных

### Требования к развертыванию
- **Время простоя**: Минимальное (не более 2 часов)
- **Откат**: Возможность быстрого отката к предыдущей версии
- **Мониторинг**: Отслеживание работы новой функциональности
- **Обучение**: Подготовка пользователей

## Подготовка к развертыванию

### 1. Проверка готовности

#### Проверка кода
- [ ] Все тесты пройдены успешно
- [ ] Код проверен на соответствие стандартам
- [ ] Документация обновлена
- [ ] Версия помечена для релиза

#### Проверка окружения
- [ ] Тестовое окружение работает корректно
- [ ] Интеграция с 1С настроена
- [ ] База данных готова к обновлению
- [ ] Резервные копии созданы

#### Проверка зависимостей
- [ ] 1С готова к приему новых параметров
- [ ] Сетевые подключения стабильны
- [ ] Ресурсы серверов достаточны
- [ ] Мониторинг настроен

### 2. Создание резервных копий

#### Резервная копия базы данных
```sql
-- Создание полной резервной копии
BACKUP DATABASE [Chicago] 
TO DISK = 'C:\Backups\Chicago_Before_TransitOrders.bak'
WITH FORMAT, INIT, COMPRESSION;

-- Проверка целостности
RESTORE VERIFYONLY 
FROM DISK = 'C:\Backups\Chicago_Before_TransitOrders.bak';
```

#### Резервная копия конфигурации
```powershell
# Копирование конфигурационных файлов
Copy-Item "C:\Chicago\Config\*" "C:\Backups\Config_Backup\" -Recurse

# Копирование файлов приложения
Copy-Item "C:\Chicago\App\*" "C:\Backups\App_Backup\" -Recurse
```

#### Резервная копия 1С
- Экспорт конфигурации 1С
- Создание резервной копии базы данных 1С
- Сохранение настроек интеграции

### 3. Подготовка скриптов развертывания

#### Скрипт обновления базы данных
```sql
-- Создание таблицы для хранения префиксов заказов
CREATE TABLE [dbo].[OrderPrefixes] (
    [Id] INT IDENTITY(1,1) PRIMARY KEY,
    [Code] NVARCHAR(10) NOT NULL,
    [Description] NVARCHAR(255) NOT NULL,
    [OrderType] NVARCHAR(50) NOT NULL,
    [IsActive] BIT NOT NULL DEFAULT 1,
    [CreatedDate] DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);

-- Создание таблицы для магазинов Монополь
CREATE TABLE [dbo].[MonopolStores] (
    [Id] INT IDENTITY(1,1) PRIMARY KEY,
    [StoreId] NVARCHAR(50) NOT NULL,
    [Name] NVARCHAR(255) NOT NULL,
    [IsActive] BIT NOT NULL DEFAULT 1,
    [CreatedDate] DATETIME2 NOT NULL DEFAULT GETUTCDATE()
);

-- Вставка префиксов для Монополь
INSERT INTO [dbo].[OrderPrefixes] ([Code], [Description], [OrderType])
VALUES 
    ('П', 'Оплата водителю наличными (без чека)', 'Monopol'),
    ('О', 'Оплата наличными ответственному сотруднику', 'Monopol'),
    ('Ч', 'Оплата водителю наличными + чек', 'Monopol'),
    ('Б', 'Безналичный расчет', 'Monopol'),
    ('Ю', 'QR-код по безналичному расчету', 'Monopol'),
    ('А', 'Безналичный расчет через третье лицо', 'Monopol'),
    ('Т', 'Банковский терминал', 'Monopol'),
    ('Д', 'Безналичный расчет (БАКалея)', 'Monopol'),
    ('Н', 'Безналичный расчет с НДС', 'Monopol');

-- Вставка префиксов для ЛД
INSERT INTO [dbo].[OrderPrefixes] ([Code], [Description], [OrderType])
VALUES 
    ('V', 'Транзит через розничную продажу', 'LD'),
    ('Б', 'Безналичный расчет с НДС', 'LD'),
    ('О', 'Безналичный расчет с НДС + отсрочка', 'LD'),
    ('С', 'Транзит + оплата сертификатами', 'LD');

-- Вставка магазинов Монополь
INSERT INTO [dbo].[MonopolStores] ([StoreId], [Name])
VALUES 
    ('monopol-001', 'Монополь'),
    ('monopol-m-001', 'Монополь-М'),
    ('monopol-br-001', 'Монополь-БР'),
    ('monopol-market-001', 'Монополь-Маркет'),
    ('ran-trade-001', 'Ран-Трейд');

-- Создание индексов для производительности
CREATE INDEX IX_OrderPrefixes_OrderType ON [dbo].[OrderPrefixes] ([OrderType]);
CREATE INDEX IX_OrderPrefixes_IsActive ON [dbo].[OrderPrefixes] ([IsActive]);
CREATE INDEX IX_MonopolStores_IsActive ON [dbo].[MonopolStores] ([IsActive]);
```

#### Скрипт обновления конфигурации
```xml
<!-- Обновление конфигурации интеграции с 1С -->
<configuration>
  <appSettings>
    <!-- Существующие настройки -->
    <add key="1C.Integration.Enabled" value="true" />
    <add key="1C.Integration.BaseUrl" value="http://1c-server/api" />
    
    <!-- Новые настройки для транзитных заказов -->
    <add key="TransitOrders.Enabled" value="true" />
    <add key="TransitOrders.ValidatePrefixes" value="true" />
    <add key="TransitOrders.CalculateShippingDate" value="true" />
    <add key="TransitOrders.MonopolStores.Enabled" value="true" />
    <add key="TransitOrders.LDPrefixes.Enabled" value="true" />
  </appSettings>
  
  <system.web>
    <!-- Настройки для обработки транзитных заказов -->
    <httpRuntime maxRequestLength="10240" executionTimeout="300" />
  </system.web>
</configuration>
```

#### Скрипт обновления мобильного терминала
```powershell
# Скрипт обновления МТ
param(
    [string]$InstallationPath = "C:\MobileTerminal",
    [string]$BackupPath = "C:\Backups\MT_Backup"
)

# Создание резервной копии
Write-Host "Создание резервной копии МТ..."
Copy-Item $InstallationPath $BackupPath -Recurse -Force

# Остановка службы МТ
Write-Host "Остановка службы МТ..."
Stop-Service -Name "MobileTerminal" -Force

# Копирование новых файлов
Write-Host "Копирование новых файлов..."
Copy-Item ".\NewFiles\*" $InstallationPath -Recurse -Force

# Обновление конфигурации
Write-Host "Обновление конфигурации..."
Copy-Item ".\Config\MobileTerminal.config" "$InstallationPath\config\"

# Запуск службы МТ
Write-Host "Запуск службы МТ..."
Start-Service -Name "MobileTerminal"

# Проверка статуса
Write-Host "Проверка статуса службы..."
Get-Service -Name "MobileTerminal"
```

## Процесс развертывания

### Этап 1: Подготовка (30 минут)

#### 1.1 Уведомление пользователей
- Отправка уведомления о плановом обслуживании
- Информирование о времени простоя
- Подготовка инструкций для пользователей

#### 1.2 Финальная проверка
- Проверка готовности всех компонентов
- Проверка резервных копий
- Проверка скриптов развертывания

### Этап 2: Развертывание базы данных (30 минут)

#### 2.1 Остановка приложений
```powershell
# Остановка служб
Stop-Service -Name "Chicago" -Force
Stop-Service -Name "MobileTerminal" -Force
Stop-Service -Name "IntegrationService" -Force
```

#### 2.2 Обновление базы данных
```sql
-- Выполнение скриптов обновления
-- Проверка целостности данных
-- Создание индексов
-- Обновление статистики
```

#### 2.3 Проверка обновления
```sql
-- Проверка создания таблиц
SELECT COUNT(*) FROM [dbo].[OrderPrefixes];
SELECT COUNT(*) FROM [dbo].[MonopolStores];

-- Проверка данных
SELECT * FROM [dbo].[OrderPrefixes] WHERE [OrderType] = 'Monopol';
SELECT * FROM [dbo].[MonopolStores] WHERE [IsActive] = 1;
```

### Этап 3: Развертывание приложений (45 минут)

#### 3.1 Обновление Чикаго
```powershell
# Копирование новых файлов
Copy-Item ".\Chicago\*" "C:\Chicago\" -Recurse -Force

# Обновление конфигурации
Copy-Item ".\Config\Chicago.config" "C:\Chicago\config\"

# Запуск службы
Start-Service -Name "Chicago"
```

#### 3.2 Обновление мобильного терминала
```powershell
# Выполнение скрипта обновления МТ
.\Update-MobileTerminal.ps1 -InstallationPath "C:\MobileTerminal"
```

#### 3.3 Обновление службы интеграции
```powershell
# Обновление службы интеграции с 1С
Copy-Item ".\IntegrationService\*" "C:\IntegrationService\" -Recurse -Force
Start-Service -Name "IntegrationService"
```

### Этап 4: Настройка интеграции (30 минут)

#### 4.1 Настройка 1С
- Обновление конфигурации 1С
- Настройка приема новых параметров
- Тестирование интеграции

#### 4.2 Настройка мониторинга
```powershell
# Настройка мониторинга транзитных заказов
Set-EventLog -LogName "Application" -Source "TransitOrders" -Enabled $true
```

### Этап 5: Тестирование (30 минут)

#### 5.1 Базовое тестирование
- Проверка запуска всех служб
- Проверка подключения к базе данных
- Проверка интеграции с 1С

#### 5.2 Функциональное тестирование
- Создание тестового транзитного заказа
- Проверка передачи данных в 1С
- Проверка расчета даты отгрузки

### Этап 6: Запуск в продуктив (15 минут)

#### 6.1 Постепенный запуск
- Включение функциональности для тестовых пользователей
- Мониторинг работы системы
- Постепенное расширение на всех пользователей

#### 6.2 Финальная проверка
- Проверка всех компонентов
- Мониторинг производительности
- Проверка логов на ошибки

## Проверка развертывания

### 1. Проверка компонентов

#### Проверка служб
```powershell
# Проверка статуса всех служб
Get-Service -Name "Chicago", "MobileTerminal", "IntegrationService"

# Проверка логов
Get-EventLog -LogName "Application" -Source "Chicago" -Newest 10
Get-EventLog -LogName "Application" -Source "MobileTerminal" -Newest 10
```

#### Проверка базы данных
```sql
-- Проверка целостности
DBCC CHECKDB('Chicago');

-- Проверка новых таблиц
SELECT COUNT(*) FROM [dbo].[OrderPrefixes];
SELECT COUNT(*) FROM [dbo].[MonopolStores];

-- Проверка производительности
SELECT * FROM sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, 'DETAILED');
```

### 2. Функциональная проверка

#### Создание тестового заказа
1. Открыть мобильный терминал
2. Создать транзитный заказ
3. Выбрать параметры
4. Сохранить заказ
5. Проверить в 1С

#### Проверка интеграции
- Проверка передачи данных в 1С
- Проверка обработки ошибок
- Проверка производительности

### 3. Мониторинг

#### Ключевые метрики
- **Производительность**: Время отклика системы
- **Ошибки**: Количество ошибок в логах
- **Интеграция**: Успешность передачи в 1С
- **Пользователи**: Количество активных пользователей

#### Настройка алертов
```powershell
# Настройка алертов для критических ошибок
$Alert = @{
    Name = "TransitOrdersError"
    Query = "EventLog[Application] | where Source == 'TransitOrders' and Level == 'Error'"
    Threshold = 5
    Action = "Send-Email -To 'admin@company.com' -Subject 'Transit Orders Error'"
}
```

## План отката

### Условия для отката
- Критические ошибки в работе системы
- Проблемы с интеграцией с 1С
- Снижение производительности более чем на 50%
- Невозможность создания заказов

### Процедура отката

#### 1. Немедленный откат (15 минут)
```powershell
# Остановка всех служб
Stop-Service -Name "Chicago", "MobileTerminal", "IntegrationService" -Force

# Восстановление из резервной копии
Restore-Database -Database "Chicago" -BackupFile "C:\Backups\Chicago_Before_TransitOrders.bak"

# Восстановление приложений
Copy-Item "C:\Backups\App_Backup\*" "C:\Chicago\" -Recurse -Force
Copy-Item "C:\Backups\MT_Backup\*" "C:\MobileTerminal\" -Recurse -Force

# Запуск служб
Start-Service -Name "Chicago", "MobileTerminal", "IntegrationService"
```

#### 2. Проверка отката
- Проверка работы всех служб
- Проверка базы данных
- Тестирование основной функциональности
- Уведомление пользователей

### Восстановление после отката
1. Анализ причин проблем
2. Исправление найденных ошибок
3. Повторное тестирование
4. Планирование повторного развертывания

## Обучение пользователей

### 1. Подготовка материалов
- Инструкции по использованию
- Видео-уроки
- FAQ по часто задаваемым вопросам
- Контакты для поддержки

### 2. Проведение обучения
- Групповые сессии для менеджеров
- Индивидуальные консультации
- Демонстрация функциональности
- Практические упражнения

### 3. Поддержка после развертывания
- Горячая линия поддержки
- Онлайн-чат с поддержкой
- База знаний
- Регулярные обновления

## Мониторинг и поддержка

### 1. Ежедневный мониторинг
- Проверка логов на ошибки
- Мониторинг производительности
- Проверка интеграции с 1С
- Анализ использования функциональности

### 2. Еженедельный анализ
- Статистика использования транзитных заказов
- Анализ производительности
- Обратная связь от пользователей
- Планирование улучшений

### 3. Ежемесячный отчет
- Общая статистика работы
- Найденные проблемы и их решения
- Рекомендации по улучшению
- Планы на следующий месяц

## Заключение

### Критерии успешного развертывания
- ✅ Все службы работают стабильно
- ✅ Интеграция с 1С функционирует
- ✅ Пользователи могут создавать транзитные заказы
- ✅ Производительность не снизилась
- ✅ Нет критических ошибок

### Следующие шаги
1. **Мониторинг**: Отслеживание работы системы
2. **Поддержка**: Помощь пользователям
3. **Оптимизация**: Улучшение на основе обратной связи
4. **Развитие**: Добавление новых функций

### Контакты для поддержки
- **Техническая поддержка**: support@company.com
- **Горячая линия**: +7 (XXX) XXX-XX-XX
- **Документация**: https://docs.company.com/transit-orders

---
*Документ создан: 27.09.2025*  
*Версия: 1.0*  
*Статус: Готово к развертыванию*
