# Руководство по тестированию: АБИ. Подключение к новому API OSA Магнит

## Обзор тестирования

### Цель тестирования
Проверить корректность работы интеграции с новым API OSA Магнит V2 и обеспечить стабильную работу всех компонентов системы.

### Области тестирования
1. **API интеграция** - подключение к новому API V2
2. **Аутентификация** - работа с сертификатами и токенами
3. **Обработка данных** - получение и отправка сигналов
4. **Мобильный терминал** - отображение и работа с данными
5. **Безопасность** - проверка защиты данных
6. **Производительность** - нагрузочное тестирование

## Подготовка к тестированию

### Требования к окружению
- **Версия МТ**: 3.6.206.5 или выше
- **Окружение**: UAT (User Acceptance Testing)
- **Сертификаты**: Настроены на серверах клиента
- **API доступ**: Доступ к тестовому API OSA Магнит V2
- **Тестовые данные**: Подготовлены заранее

### Тестовые данные

#### Тестовые сигналы
```json
{
  "test_signals": [
    {
      "id": "test_signal_001",
      "type": "merchandising",
      "store_id": "test_store_001",
      "product_code": "TEST_PROD_001",
      "issue_type": "placement",
      "description": "Неправильное размещение товара",
      "priority": "high",
      "created_at": "2025-09-25T10:00:00Z",
      "due_date": "2025-09-27T18:00:00Z"
    },
    {
      "id": "test_signal_002",
      "type": "product_issue",
      "store_id": "test_store_002",
      "product_code": "TEST_PROD_002",
      "issue_type": "quality",
      "description": "Проблема с качеством товара",
      "priority": "medium",
      "created_at": "2025-09-25T11:00:00Z",
      "due_date": "2025-09-28T18:00:00Z"
    }
  ]
}
```

#### Тестовые коды проблем
```json
{
  "problem_codes": [
    {
      "code": "PLACEMENT_001",
      "description": "Неправильное размещение товара",
      "category": "merchandising"
    },
    {
      "code": "QUALITY_001",
      "description": "Проблема с качеством товара",
      "category": "product_issue"
    }
  ]
}
```

## Тест-кейсы

### TC-001: Подключение к API V2

#### Описание
Проверка успешного подключения к новому API OSA Магнит V2.

#### Предусловия
- Сертификаты установлены на серверах
- Доступ к тестовому API получен
- Система обновлена до версии 3.6.206.5+

#### Шаги выполнения
1. Запустить систему
2. Проверить загрузку сертификатов
3. Выполнить аутентификацию с API
4. Проверить получение access_token
5. Выполнить тестовый запрос к API

#### Ожидаемый результат
- Сертификаты загружены успешно
- Аутентификация прошла без ошибок
- Access_token получен и валиден
- Тестовый запрос выполнен успешно

#### Проверочные запросы
```bash
# Проверка подключения
curl -X GET "https://api.magnet.ru/osa/v2/health" \
  -H "Authorization: Bearer {access_token}" \
  -H "Content-Type: application/json"

# Ожидаемый ответ
{
  "status": "ok",
  "version": "2.0",
  "timestamp": "2025-09-25T10:00:00Z"
}
```

### TC-002: Получение сигналов

#### Описание
Проверка корректности получения сигналов от API V2.

#### Предусловия
- Подключение к API установлено (TC-001)
- В API есть тестовые сигналы
- Функциональный флаг V2 включен

#### Шаги выполнения
1. Выполнить запрос получения сигналов
2. Проверить корректность ответа
3. Проверить сохранение в БД
4. Проверить синхронизацию с МТ

#### Ожидаемый результат
- Сигналы получены в корректном формате
- Данные сохранены в БД без ошибок
- Синхронизация с МТ прошла успешно
- Отображение в интерфейсе корректно

#### Проверочные запросы
```sql
-- Проверка сохраненных сигналов
SELECT COUNT(*) as signal_count FROM osa_signals_v2;

-- Проверка конкретного сигнала
SELECT * FROM osa_signals_v2 WHERE signal_id = 'test_signal_001';
```

### TC-003: Отправка обратной связи

#### Описание
Проверка корректности отправки обратной связи в API V2.

#### Предусловия
- Сигналы получены (TC-002)
- Мерчандайзер заполнил форму обратной связи
- Фотографии загружены

#### Шаги выполнения
1. Выбрать сигнал для ответа
2. Заполнить форму обратной связи
3. Загрузить фотографии
4. Отправить ответ
5. Проверить статус отправки

#### Ожидаемый результат
- Форма заполнена корректно
- Фотографии загружены успешно
- Ответ отправлен без ошибок
- Статус сигнала обновлен

#### Тестовые данные
```json
{
  "feedback": {
    "signal_id": "test_signal_001",
    "status": "completed",
    "resolution": "Проблема устранена",
    "photos": ["photo1.jpg", "photo2.jpg"],
    "completed_at": "2025-09-25T15:30:00Z",
    "merchandiser_id": "merch_001"
  }
}
```

### TC-004: Импорт кодов проблем

#### Описание
Проверка корректности импорта кодов проблем в систему.

#### Предусловия
- API V2 доступен
- Коды проблем получены от Магнит
- Система готова к импорту

#### Шаги выполнения
1. Получить коды проблем от API
2. Выполнить импорт в БД
3. Проверить корректность данных
4. Проверить отображение в интерфейсе

#### Ожидаемый результат
- Коды проблем импортированы успешно
- Данные корректно сохранены в БД
- Отображение в интерфейсе работает
- Фильтрация по кодам функционирует

#### Проверочные запросы
```sql
-- Проверка импортированных кодов
SELECT COUNT(*) as codes_count FROM osa_problem_codes;

-- Проверка конкретного кода
SELECT * FROM osa_problem_codes WHERE code = 'PLACEMENT_001';
```

### TC-005: Отображение в МТ

#### Описание
Проверка корректности отображения данных в мобильном терминале.

#### Предусловия
- МТ обновлен до версии 3.6.206.5+
- Данные синхронизированы с сервером
- Функциональные флаги включены

#### Шаги выполнения
1. Открыть МТ
2. Выполнить синхронизацию данных
3. Проверить отображение сигналов
4. Проверить работу фильтров
5. Проверить форму обратной связи

#### Ожидаемый результат
- Синхронизация прошла успешно
- Сигналы отображаются корректно
- Фильтры работают правильно
- Форма обратной связи функционирует

### TC-006: Отправка графиков работы

#### Описание
Проверка корректности отправки графиков работы мерчандайзеров.

#### Предусловия
- Графики работы сформированы
- API V2 доступен
- Настройки уведомлений настроены

#### Шаги выполнения
1. Сформировать график работы
2. Отправить через API V2
3. Проверить статус отправки
4. Проверить уведомление на почту

#### Ожидаемый результат
- График отправлен успешно
- Статус отправки корректный
- Уведомление на почту получено
- Данные сохранены в системе

### TC-007: Обработка ошибок

#### Описание
Проверка корректности обработки различных типов ошибок.

#### Тест-кейс 7.1: Ошибка аутентификации
1. Использовать неверный сертификат
2. Попытаться выполнить запрос
3. Проверить обработку ошибки

**Ожидаемый результат**: Система корректно обрабатывает ошибку и пытается переподключиться

#### Тест-кейс 7.2: Ошибка сети
1. Отключить сеть
2. Попытаться выполнить запрос
3. Восстановить сеть
4. Проверить восстановление

**Ожидаемый результат**: Система корректно обрабатывает ошибку и восстанавливается

#### Тест-кейс 7.3: Ошибка данных
1. Отправить некорректные данные
2. Проверить обработку ошибки
3. Проверить логирование

**Ожидаемый результат**: Ошибка залогирована, система продолжает работу

### TC-008: Производительность

#### Описание
Проверка производительности системы под нагрузкой.

#### Шаги выполнения
1. Создать 1000 тестовых сигналов
2. Запустить получение сигналов
3. Измерить время обработки
4. Проверить использование ресурсов

#### Ожидаемый результат
- Время обработки < 5 секунд
- Использование памяти в пределах нормы
- CPU нагрузка < 80%
- Нет утечек памяти

### TC-009: Безопасность

#### Описание
Проверка безопасности передачи и хранения данных.

#### Шаги выполнения
1. Проверить шифрование трафика
2. Проверить защиту сертификатов
3. Проверить логирование чувствительных данных
4. Проверить права доступа

#### Ожидаемый результат
- Все данные передаются по HTTPS
- Сертификаты защищены
- Чувствительные данные не логируются
- Права доступа настроены корректно

## Автоматизированное тестирование

### Unit тесты
```csharp
[Test]
public async Task GetSignals_ValidRequest_ReturnsSignals()
{
    // Arrange
    var apiClient = new OsaApiClient(_mockHttpClient);
    var expectedSignals = new List<Signal> { /* test data */ };
    
    // Act
    var result = await apiClient.GetSignalsAsync();
    
    // Assert
    Assert.That(result.Count, Is.EqualTo(expectedSignals.Count));
    Assert.That(result[0].Id, Is.EqualTo(expectedSignals[0].Id));
}
```

### Integration тесты
```csharp
[Test]
public async Task SendFeedback_ValidData_Success()
{
    // Arrange
    var feedback = new Feedback
    {
        SignalId = "test_signal_001",
        Status = "completed",
        Resolution = "Проблема устранена"
    };
    
    // Act
    var result = await _apiClient.SendFeedbackAsync(feedback);
    
    // Assert
    Assert.That(result.IsSuccess, Is.True);
    Assert.That(result.StatusCode, Is.EqualTo(HttpStatusCode.OK));
}
```

### E2E тесты
```csharp
[Test]
public async Task CompleteSignalWorkflow_Success()
{
    // Arrange
    var merchandiser = new Merchandiser { Id = "merch_001" };
    var signal = await GetTestSignal();
    
    // Act
    await _system.ProcessSignalAsync(signal, merchandiser);
    
    // Assert
    var feedback = await _database.GetFeedbackAsync(signal.Id);
    Assert.That(feedback, Is.Not.Null);
    Assert.That(feedback.Status, Is.EqualTo("completed"));
}
```

## Критерии приемки

### Функциональные критерии
- ✅ Все тест-кейсы TC-001 - TC-009 пройдены успешно
- ✅ API интеграция работает стабильно
- ✅ Получение и отправка сигналов функционирует
- ✅ МТ отображает данные корректно
- ✅ Обработка ошибок работает правильно
- ✅ Производительность в пределах нормы
- ✅ Безопасность обеспечена

### Производительностные критерии
- ✅ Время отклика API < 5 секунд
- ✅ Время обработки сигналов < 2 секунд
- ✅ Использование памяти < 1 GB
- ✅ CPU нагрузка < 80%

### Критерии качества
- ✅ Нет критических ошибок в логах
- ✅ Данные не теряются при обработке
- ✅ Система стабильно работает 24/7
- ✅ Автоматические тесты покрывают 90% кода

## Отчетность

### Формат отчета о тестировании
```
Тест-кейс: TC-XXX
Статус: ПРОЙДЕН/НЕ ПРОЙДЕН
Время выполнения: XX:XX
Ошибки: [список ошибок]
Комментарии: [дополнительная информация]
Скриншоты: [ссылки на скриншоты]
```

### Логи для анализа
- Логи API: `logs/api.log`
- Логи системы: `logs/system.log`
- Логи МТ: `logs/mobile.log`
- Логи БД: `logs/database.log`

## План тестирования

### Этап 1: Подготовка (1 день)
- Настройка тестового окружения
- Подготовка тестовых данных
- Проверка доступности API
- Настройка мониторинга

### Этап 2: Функциональное тестирование (2 дня)
- Выполнение тест-кейсов TC-001 - TC-005
- Документирование результатов
- Исправление найденных ошибок

### Этап 3: Интеграционное тестирование (1 день)
- Выполнение тест-кейсов TC-006 - TC-009
- Проверка взаимодействия компонентов
- Нагрузочное тестирование

### Этап 4: Приемочное тестирование (1 день)
- Финальная проверка всех функций
- Подготовка отчета о тестировании
- Подписание акта приемки

## Контакты

- **Ответственный за тестирование**: Макаренко Илья
- **Техническая поддержка**: Ярочкин Артем
- **Координатор**: Оздоган Татьяна

---
*Документ создан: 27.09.2025*  
*Версия: 1.0*  
*Статус: Готов к использованию*
