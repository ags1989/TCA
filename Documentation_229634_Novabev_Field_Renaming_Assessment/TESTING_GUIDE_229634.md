# Руководство по тестированию: Novabev. Переименование полей в Ч-Web

## Обзор тестирования

### Цель тестирования
Убедиться, что система переименования полей в Чикаго Web работает корректно, обеспечивает изоляцию между тенантами и сохраняет настройки при обновлениях системы.

### Области тестирования
1. **Функциональное тестирование**: Корректность переименования полей
2. **Интеграционное тестирование**: Взаимодействие с существующими компонентами
3. **Тестирование производительности**: Влияние на скорость работы системы
4. **Тестирование безопасности**: Изоляция между тенантами
5. **Регрессионное тестирование**: Отсутствие влияния на существующий функционал

## Тестовые сценарии

### 1. Тестирование переименования полей

#### Сценарий 1.1: Переименование поля "Код" в "Код SY" для ТТ
**Цель**: Проверить корректность переименования поля в справочнике торговых точек

**Предусловия**:
- Система развернута и настроена
- Создан файл переводов для тенанта Novabev
- Пользователь авторизован под тенантом Novabev

**Шаги выполнения**:
1. Открыть справочник "Торговые точки"
2. Проверить отображение заголовка колонки "Код"
3. Открыть карточку торговой точки
4. Проверить отображение метки поля "Код"

**Ожидаемый результат**:
- В таблице заголовок колонки отображается как "Код SY"
- В форме метка поля отображается как "Код SY"
- Функциональность работы с полем не нарушена

**Критерии приемки**:
- ✅ Заголовок колонки: "Код SY"
- ✅ Метка поля: "Код SY"
- ✅ Данные отображаются корректно
- ✅ Поиск и фильтрация работают

#### Сценарий 1.2: Переименование полей в других справочниках
**Цель**: Проверить переименование полей в справочниках "Товары" и "Контрагенты"

**Предусловия**:
- Настроены переводы для всех справочников
- Пользователь авторизован под тенантом Novabev

**Шаги выполнения**:
1. Открыть справочник "Товары"
2. Проверить переименованные поля
3. Открыть справочник "Контрагенты"
4. Проверить переименованные поля

**Ожидаемый результат**:
- Все поля отображаются с переименованными заголовками
- Функциональность справочников не нарушена

**Критерии приемки**:
- ✅ Товары: "Название товара", "Артикул", "Цена продажи"
- ✅ Контрагенты: "ИНН/КПП", "Наименование организации"
- ✅ Все операции работают корректно

### 2. Тестирование мультитенантности

#### Сценарий 2.1: Изоляция настроек между тенантами
**Цель**: Убедиться, что настройки одного тенанта не влияют на другой

**Предусловия**:
- Настроены разные переводы для тенантов Novabev и Default
- Пользователь может переключаться между тенантами

**Шаги выполнения**:
1. Авторизоваться под тенантом Novabev
2. Проверить отображение полей (должны быть переименованы)
3. Переключиться на тенант Default
4. Проверить отображение полей (должны быть стандартные)

**Ожидаемый результат**:
- Novabev: поля переименованы согласно настройкам
- Default: поля отображаются со стандартными названиями

**Критерии приемки**:
- ✅ Изоляция настроек работает
- ✅ Переключение тенантов корректно
- ✅ Нет влияния между тенантами

#### Сценарий 2.2: Отсутствие переводов для тенанта
**Цель**: Проверить fallback на стандартные названия при отсутствии переводов

**Предусловия**:
- Создан новый тенант без файлов переводов
- Пользователь авторизован под новым тенантом

**Шаги выполнения**:
1. Авторизоваться под новым тенантом
2. Открыть справочники
3. Проверить отображение полей

**Ожидаемый результат**:
- Поля отображаются со стандартными названиями
- Система работает без ошибок
- Показывается предупреждение о загрузке переводов

**Критерии приемки**:
- ✅ Fallback работает корректно
- ✅ Нет ошибок в консоли
- ✅ Показывается уведомление пользователю

### 3. Тестирование сохранения при обновлениях

#### Сценарий 3.1: Сохранение настроек после обновления
**Цель**: Убедиться, что настройки переводов сохраняются при обновлении системы

**Предусловия**:
- Настроены переводы для тенанта
- Система работает с переименованными полями
- Подготовлено обновление системы

**Шаги выполнения**:
1. Зафиксировать текущие настройки переводов
2. Выполнить обновление системы
3. Проверить сохранение настроек
4. Проверить работу переименованных полей

**Ожидаемый результат**:
- Настройки переводов сохранены
- Поля продолжают отображаться с переименованными названиями
- Функциональность не нарушена

**Критерии приемки**:
- ✅ Файлы переводов сохранены
- ✅ Настройки применены после обновления
- ✅ Нет потери функциональности

### 4. Тестирование импорта данных

#### Сценарий 4.1: Импорт с оригинальными названиями полей
**Цель**: Проверить, что импорт данных работает с оригинальными названиями полей

**Предусловия**:
- Настроены переводы для тенанта
- Подготовлен файл импорта с оригинальными названиями полей

**Шаги выполнения**:
1. Подготовить файл импорта с полем "Код" (не "Код SY")
2. Выполнить импорт торговых точек
3. Проверить корректность импорта
4. Проверить отображение в интерфейсе

**Ожидаемый результат**:
- Импорт выполняется успешно
- Данные сохраняются корректно
- В интерфейсе отображается "Код SY"

**Критерии приемки**:
- ✅ Импорт работает с оригинальными названиями
- ✅ Данные сохраняются корректно
- ✅ Отображение соответствует настройкам

#### Сценарий 4.2: Ошибка при использовании переименованных полей в импорте
**Цель**: Проверить, что система корректно обрабатывает ошибки при использовании переименованных полей

**Предусловия**:
- Настроены переводы для тенанта
- Подготовлен файл импорта с переименованными названиями полей

**Шаги выполнения**:
1. Подготовить файл импорта с полем "Код SY" (переименованное)
2. Выполнить импорт торговых точек
3. Проверить обработку ошибки

**Ожидаемый результат**:
- Импорт завершается с ошибкой
- Показывается понятное сообщение об ошибке
- Предлагается использовать оригинальное название поля

**Критерии приемки**:
- ✅ Ошибка обрабатывается корректно
- ✅ Сообщение об ошибке понятное
- ✅ Предлагается решение проблемы

### 5. Тестирование производительности

#### Сценарий 5.1: Время загрузки переводов
**Цель**: Проверить, что загрузка переводов не замедляет работу системы

**Предусловия**:
- Система настроена с переводами
- Подготовлены инструменты для измерения производительности

**Шаги выполнения**:
1. Измерить время загрузки страницы без переводов
2. Измерить время загрузки страницы с переводами
3. Сравнить результаты
4. Проверить кэширование переводов

**Ожидаемый результат**:
- Время загрузки увеличивается незначительно
- Переводы кэшируются после первой загрузки
- Повторные загрузки выполняются быстрее

**Критерии приемки**:
- ✅ Увеличение времени загрузки < 200ms
- ✅ Кэширование работает корректно
- ✅ Повторные загрузки быстрее

#### Сценарий 5.2: Влияние на работу с большими данными
**Цель**: Проверить, что переименование не влияет на работу с большими объемами данных

**Предусловия**:
- Настроены переводы для тенанта
- Подготовлен большой набор тестовых данных

**Шаги выполнения**:
1. Загрузить большой справочник торговых точек
2. Проверить время отображения
3. Выполнить операции поиска и фильтрации
4. Проверить время выполнения операций

**Ожидаемый результат**:
- Производительность не ухудшается значительно
- Все операции выполняются в приемлемое время
- Нет проблем с памятью

**Критерии приемки**:
- ✅ Время отображения приемлемое
- ✅ Поиск и фильтрация работают быстро
- ✅ Нет утечек памяти

### 6. Тестирование ошибок

#### Сценарий 6.1: Поврежденный файл переводов
**Цель**: Проверить обработку ошибок при поврежденном файле переводов

**Предусловия**:
- Подготовлен поврежденный файл переводов
- Система настроена на использование этого файла

**Шаги выполнения**:
1. Заменить файл переводов на поврежденный
2. Перезагрузить страницу
3. Проверить обработку ошибки
4. Проверить fallback на стандартные названия

**Ожидаемый результат**:
- Ошибка обрабатывается корректно
- Система переключается на стандартные названия
- Показывается уведомление пользователю

**Критерии приемки**:
- ✅ Ошибка не ломает систему
- ✅ Fallback работает
- ✅ Пользователь уведомлен

#### Сценарий 6.2: Отсутствующий файл переводов
**Цель**: Проверить обработку отсутствующего файла переводов

**Предусловия**:
- Файл переводов удален или недоступен
- Система настроена на использование этого файла

**Шаги выполнения**:
1. Удалить файл переводов
2. Перезагрузить страницу
3. Проверить обработку ошибки
4. Проверить работу системы

**Ожидаемый результат**:
- Система работает со стандартными названиями
- Ошибка логируется
- Пользователь уведомлен

**Критерии приемки**:
- ✅ Система работает стабильно
- ✅ Ошибка логируется
- ✅ Пользователь уведомлен

## Автоматизированное тестирование

### 1. Unit тесты

#### Тест сервиса локализации
```typescript
describe('FieldLocalizationService', () => {
  let service: FieldLocalizationService;
  let httpMock: jasmine.SpyObj<HttpClient>;
  let tenantResolverMock: jasmine.SpyObj<TenantResolver>;

  beforeEach(() => {
    const httpSpy = jasmine.createSpyObj('HttpClient', ['get']);
    const tenantSpy = jasmine.createSpyObj('TenantResolver', ['getCurrentTenant']);

    TestBed.configureTestingModule({
      providers: [
        FieldLocalizationService,
        { provide: HttpClient, useValue: httpSpy },
        { provide: TenantResolver, useValue: tenantSpy }
      ]
    });

    service = TestBed.inject(FieldLocalizationService);
    httpMock = TestBed.inject(HttpClient) as jasmine.SpyObj<HttpClient>;
    tenantResolverMock = TestBed.inject(TenantResolver) as jasmine.SpyObj<TenantResolver>;
  });

  it('should return localized field name when translation exists', async () => {
    // Arrange
    const translations = {
      outlets: { code: 'Код SY' }
    };
    httpMock.get.and.returnValue(of(translations));
    tenantResolverMock.getCurrentTenant.and.returnValue('novabev');

    // Act
    await service.loadTranslations();
    const result = service.getFieldName('outlets', 'code');

    // Assert
    expect(result).toBe('Код SY');
  });

  it('should return default field name when translation does not exist', () => {
    // Arrange
    tenantResolverMock.getCurrentTenant.and.returnValue('novabev');

    // Act
    const result = service.getFieldName('outlets', 'code');

    // Assert
    expect(result).toBe('Код');
  });

  it('should handle translation loading errors gracefully', async () => {
    // Arrange
    httpMock.get.and.returnValue(throwError('Network error'));
    tenantResolverMock.getCurrentTenant.and.returnValue('novabev');

    // Act & Assert
    await expectAsync(service.loadTranslations()).toBeResolved();
    const result = service.getFieldName('outlets', 'code');
    expect(result).toBe('Код');
  });
});
```

#### Тест компонента таблицы
```typescript
describe('LocalizedGridComponent', () => {
  let component: LocalizedGridComponent;
  let fixture: ComponentFixture<LocalizedGridComponent>;
  let fieldLocalizationMock: jasmine.SpyObj<FieldLocalizationService>;

  beforeEach(async () => {
    const fieldLocalizationSpy = jasmine.createSpyObj('FieldLocalizationService', ['getFieldName']);

    await TestBed.configureTestingModule({
      declarations: [LocalizedGridComponent],
      providers: [
        { provide: FieldLocalizationService, useValue: fieldLocalizationSpy }
      ]
    }).compileComponents();

    fixture = TestBed.createComponent(LocalizedGridComponent);
    component = fixture.componentInstance;
    fieldLocalizationMock = TestBed.inject(FieldLocalizationService) as jasmine.SpyObj<FieldLocalizationService>;
  });

  it('should display localized headers', () => {
    // Arrange
    component.columns = [
      { entityName: 'outlets', fieldName: 'code', title: 'Code' }
    ];
    component.data = [{ code: 'TT001' }];
    fieldLocalizationMock.getFieldName.and.returnValue('Код SY');

    // Act
    fixture.detectChanges();

    // Assert
    const headerElement = fixture.debugElement.query(By.css('th')).nativeElement;
    expect(headerElement.textContent.trim()).toBe('Код SY');
    expect(fieldLocalizationMock.getFieldName).toHaveBeenCalledWith('outlets', 'code');
  });

  it('should handle missing translations gracefully', () => {
    // Arrange
    component.columns = [
      { entityName: 'outlets', fieldName: 'code', title: 'Code' }
    ];
    component.data = [{ code: 'TT001' }];
    fieldLocalizationMock.getFieldName.and.returnValue('code');

    // Act
    fixture.detectChanges();

    // Assert
    const headerElement = fixture.debugElement.query(By.css('th')).nativeElement;
    expect(headerElement.textContent.trim()).toBe('code');
  });
});
```

### 2. Интеграционные тесты

#### Тест загрузки переводов
```typescript
describe('Translation Loading Integration', () => {
  let httpTestingController: HttpTestingController;
  let service: FieldLocalizationService;

  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
      providers: [FieldLocalizationService, TenantResolver]
    });

    httpTestingController = TestBed.inject(HttpTestingController);
    service = TestBed.inject(FieldLocalizationService);
  });

  afterEach(() => {
    httpTestingController.verify();
  });

  it('should load translations from correct URL', () => {
    // Arrange
    const mockTranslations = {
      outlets: { code: 'Код SY' }
    };

    // Act
    service.loadTranslations().then(() => {
      const result = service.getFieldName('outlets', 'code');
      expect(result).toBe('Код SY');
    });

    // Assert
    const req = httpTestingController.expectOne('assets/locale/tenants/novabev/ru-RU.json');
    expect(req.request.method).toBe('GET');
    req.flush(mockTranslations);
  });

  it('should handle 404 errors gracefully', () => {
    // Act
    service.loadTranslations().then(() => {
      const result = service.getFieldName('outlets', 'code');
      expect(result).toBe('Код');
    });

    // Assert
    const req = httpTestingController.expectOne('assets/locale/tenants/novabev/ru-RU.json');
    req.flush('Not found', { status: 404, statusText: 'Not Found' });
  });
});
```

### 3. E2E тесты

#### Тест переименования полей в интерфейсе
```typescript
describe('Field Renaming E2E', () => {
  let page: AppPage;

  beforeEach(() => {
    page = new AppPage();
  });

  it('should display renamed fields in outlets grid', async () => {
    // Arrange
    await page.navigateTo('/outlets');
    await page.waitForGridToLoad();

    // Act
    const headerText = await page.getGridHeaderText('code');

    // Assert
    expect(headerText).toBe('Код SY');
  });

  it('should display renamed fields in outlet form', async () => {
    // Arrange
    await page.navigateTo('/outlets');
    await page.clickAddButton();

    // Act
    const fieldLabel = await page.getFieldLabel('code');

    // Assert
    expect(fieldLabel).toBe('Код SY');
  });

  it('should handle tenant switching correctly', async () => {
    // Arrange
    await page.navigateTo('/outlets');
    await page.waitForGridToLoad();

    // Act - Switch to Novabev tenant
    await page.switchTenant('novabev');
    const novabevHeader = await page.getGridHeaderText('code');

    // Switch to Default tenant
    await page.switchTenant('default');
    const defaultHeader = await page.getGridHeaderText('code');

    // Assert
    expect(novabevHeader).toBe('Код SY');
    expect(defaultHeader).toBe('Код');
  });
});
```

## Чек-лист тестирования

### Функциональное тестирование
- [ ] Переименование поля "Код" в "Код SY" для ТТ
- [ ] Переименование полей в справочнике "Товары"
- [ ] Переименование полей в справочнике "Контрагенты"
- [ ] Отображение переименованных полей в таблицах
- [ ] Отображение переименованных полей в формах
- [ ] Работа поиска и фильтрации с переименованными полями
- [ ] Сохранение и редактирование данных

### Мультитенантность
- [ ] Изоляция настроек между тенантами
- [ ] Корректное переключение между тенантами
- [ ] Fallback на стандартные названия при отсутствии переводов
- [ ] Обработка ошибок загрузки переводов

### Импорт данных
- [ ] Импорт с оригинальными названиями полей
- [ ] Обработка ошибок при использовании переименованных полей
- [ ] Валидация файлов импорта
- [ ] Сохранение данных после импорта

### Производительность
- [ ] Время загрузки переводов
- [ ] Кэширование переводов
- [ ] Влияние на работу с большими данными
- [ ] Использование памяти

### Обработка ошибок
- [ ] Поврежденный файл переводов
- [ ] Отсутствующий файл переводов
- [ ] Некорректный формат JSON
- [ ] Сетевые ошибки

### Регрессионное тестирование
- [ ] Работа существующих функций не нарушена
- [ ] API продолжает работать корректно
- [ ] ХП используют оригинальные названия полей
- [ ] Интеграции с внешними системами работают

## Критерии готовности к релизу

### Обязательные критерии
- [ ] Все функциональные тесты пройдены
- [ ] Мультитенантность работает корректно
- [ ] Импорт данных функционирует
- [ ] Производительность в пределах нормы
- [ ] Обработка ошибок реализована
- [ ] Регрессионные тесты пройдены

### Дополнительные критерии
- [ ] Автоматизированные тесты покрывают основные сценарии
- [ ] Документация обновлена
- [ ] Обучение пользователей проведено
- [ ] Мониторинг настроен
- [ ] План отката подготовлен

## Отчетность

### Формат отчета о тестировании
```
Тест: [Название теста]
Статус: [Пройден/Провален/Пропущен]
Время выполнения: [Время]
Окружение: [Тестовое окружение]
Браузер: [Версия браузера]
Комментарии: [Дополнительная информация]
Скриншоты: [Ссылки на скриншоты]
```

### Метрики качества
- **Покрытие тестами**: > 80%
- **Время выполнения тестов**: < 30 минут
- **Количество багов**: < 5 критических
- **Производительность**: Ухудшение < 10%

---
*Документ создан: 27.09.2025*  
*Версия: 1.0*  
*Статус: Готов к использованию*
