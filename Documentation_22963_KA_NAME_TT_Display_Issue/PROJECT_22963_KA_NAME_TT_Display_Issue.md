# Проект 22963: KA_NAME ТТ - Проблема отображения названий торговых точек

## Обзор проекта

**ID тикета**: 22963  
**Тип**: Ошибка (Bug)  
**Статус**: Закрыто  
**Дата создания**: 27.02.2014  
**Дата закрытия**: 05.03.2014  
**Приоритет**: 3 (средний)  
**Серьезность**: 3 - средняя  

### Команда проекта
- **Создатель**: Vitaliy Y. Amirdzhanyan
- **Исполнитель**: Голованов Алексей
- **Проект**: Replication
- **Область**: Replication\DDL_old\Rpl2CisLink

## Описание проблемы

### Суть проблемы
В системе репликации существует проблема с отображением названий торговых точек в отчетах. Система должна использовать поле `KA_NAME` из справочника клиентов для отображения названий торговых точек, но вместо этого использует данные из входящих юридических лиц.

### Детальное описание
1. **Ожидаемое поведение**: Все торговые точки, для которых в справочнике клиентов заполнено поле `KA_NAME`, должны отражаться в отчетах с названием клиента, взятым из поля `KA_NAME`, а не из входящих юридических лиц.

2. **Фактическое поведение**: В сформированных отчетах (XML) название торговой точки берется из данных входящих юридических лиц, игнорируя поле `KA_NAME`.

3. **Конкретный пример**:
   - **Файл**: jj_clients
   - **ТТ ID**: 460011
   - **KA_NAME в справочнике**: "Шах"
   - **Отображается в XML**: "Шахабасова З.У. ИП"

### Влияние на систему
- **Функциональность**: Неправильное отображение названий торговых точек в отчетах
- **Пользователи**: Затруднения в идентификации торговых точек по отчетам
- **Данные**: Некорректная информация в выгружаемых файлах
- **Бизнес-процессы**: Проблемы с анализом данных по торговым точкам

## Техническая информация

### Компоненты системы
- **Модуль**: Replication
- **Подсистема**: Rpl2CisLink
- **Файлы**: jj_clients (справочник клиентов)
- **Формат данных**: XML отчеты

### Структура данных
```
Справочник клиентов:
├── ТТ ID (460011)
├── KA_NAME ("Шах") ← Должно использоваться
└── Юридические лица
    └── Название ("Шахабасова З.У. ИП") ← Используется неправильно
```

### Логика работы
1. **Текущая логика**:
   - Система формирует отчеты
   - Для отображения названия ТТ берет данные из юридических лиц
   - Игнорирует поле KA_NAME

2. **Требуемая логика**:
   - Система должна проверять наличие поля KA_NAME
   - Если KA_NAME заполнено, использовать его для отображения
   - Если KA_NAME пустое, использовать данные из юридических лиц

## Решение проблемы

### Подход к исправлению
1. **Анализ кода**: Найти места в коде, где формируется название ТТ для отчетов
2. **Модификация логики**: Добавить проверку поля KA_NAME
3. **Тестирование**: Проверить корректность отображения
4. **Развертывание**: Применить исправление в продакшене

### Алгоритм исправления
```sql
-- Псевдокод для исправления
IF EXISTS (SELECT 1 FROM clients WHERE tt_id = @tt_id AND KA_NAME IS NOT NULL AND KA_NAME != '')
    SET @display_name = (SELECT KA_NAME FROM clients WHERE tt_id = @tt_id)
ELSE
    SET @display_name = (SELECT legal_entity_name FROM legal_entities WHERE tt_id = @tt_id)
```

### Файлы для изменения
- **Основной код**: Файлы формирования отчетов
- **SQL запросы**: Запросы получения данных о ТТ
- **Конфигурация**: Настройки отображения названий
- **Тесты**: Unit тесты для проверки логики

## Тестирование

### Тестовые сценарии
1. **ТТ с заполненным KA_NAME**:
   - Проверить отображение KA_NAME в отчете
   - Убедиться, что юридическое лицо не используется

2. **ТТ с пустым KA_NAME**:
   - Проверить отображение названия из юридического лица
   - Убедиться, что система работает как раньше

3. **ТТ с NULL KA_NAME**:
   - Проверить корректную обработку NULL значений
   - Убедиться в отсутствии ошибок

### Критерии приемки
- ✅ ТТ с заполненным KA_NAME отображаются с названием из KA_NAME
- ✅ ТТ с пустым KA_NAME отображаются с названием из юридического лица
- ✅ Нет ошибок при обработке NULL значений
- ✅ Существующие отчеты продолжают работать корректно

## Развертывание

### Этапы развертывания
1. **Подготовка**:
   - Создание резервной копии
   - Подготовка исправленного кода
   - Тестирование на тестовом окружении

2. **Развертывание**:
   - Остановка службы репликации
   - Применение исправления
   - Запуск службы репликации

3. **Проверка**:
   - Генерация тестового отчета
   - Проверка корректности отображения
   - Мониторинг работы системы

### Откат изменений
- Восстановление из резервной копии
- Возврат к предыдущей версии кода
- Перезапуск службы репликации

## Статус реализации

### Выполненные работы
- [x] Анализ проблемы
- [x] Идентификация компонентов
- [x] Разработка решения
- [x] Тестирование исправления
- [x] Развертывание в продакшене
- [x] Закрытие тикета

### Результат
- **Статус**: Закрыто (05.03.2014)
- **Причина закрытия**: Проверено
- **Время выполнения**: 2.01 часа
- **Качество**: Исправление работает корректно

## Связанные документы

### Техническая документация
- [Техническое решение](TECHNICAL_SOLUTION_22963.md)
- [Руководство по тестированию](TESTING_GUIDE_22963.md)
- [Руководство по развертыванию](DEPLOYMENT_GUIDE_22963.md)

### Дополнительные материалы
- Прикрепленный файл: jj_clients.zip
- Логи системы репликации
- Конфигурационные файлы

## Заключение

Проблема с отображением названий торговых точек была успешно решена. Система теперь корректно использует поле `KA_NAME` из справочника клиентов для отображения названий торговых точек в отчетах, что обеспечивает более точную идентификацию торговых точек пользователями системы.

### Ключевые достижения
- ✅ Исправлена логика отображения названий ТТ
- ✅ Сохранена обратная совместимость
- ✅ Улучшена точность отчетов
- ✅ Повышена удобство использования системы

---
*Документ создан: 27.09.2025*  
*Версия: 1.0*  
*Статус: Завершен*
