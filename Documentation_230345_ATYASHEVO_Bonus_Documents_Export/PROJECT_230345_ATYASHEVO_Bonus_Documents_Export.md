# Проект 230345: Атяшево. ТМА. Выгрузка документов оснований для бонусов в УС

## Обзор проекта

**ID тикета**: 230345  
**Тип**: Запрос на изменение  
**Статус**: Выполнено (Готово к проду)  
**Дата создания**: 08.08.2025  
**Приоритет**: 2 (средняя важность)  
**Уверенность**: 3% (низкая)  

### Команда проекта
- **Создатель**: Иванов Евгений
- **Ответственный**: Иванов Евгений
- **Команда**: Foxtrot
- **Проект**: Атяшево(Талина)
- **Область**: Backlog\Foxtrot

## Описание запроса

### Суть запроса
Реализация функциональности выгрузки документов оснований для бонусов в УС (Учетная Система) с корректным заполнением поля `TargetDocumentChicagoId` в файле `BonusIssued`.

### Проблема
При срабатывании акции n+1 в файле `BonusIssued` не заполняется ссылка на заказ `TargetDocumentChicagoId`, из-за чего нет возможности подставить бонусный товар к нужному заказу средствами интеграции.

### Текущее состояние
- **Файл BonusIssued**: Не заполняется поле `TargetDocumentChicagoId`
- **Интеграция**: Невозможность связать бонус с заказом
- **Процесс**: Нарушена цепочка обработки бонусных документов

### Требование
Адаптация существующего решения с проекта АБИ для проекта Атяшево:
- Ссылка на решение АБИ: [Confluence](https://confluence.systtech.ru/pages/viewpage.action?pageId=927203376)
- Оценка адаптации для проекта Атяшево
- Реализация механизма связывания документов

## User Story

### Основная User Story
**Я, как оператор, хочу понимать какой заказ привел к сработке бонуса, чтобы иметь возможность проверять корректность начисления бонусов.**

### Детальное описание
Более полное описание доработки доступно по ссылке: [Confluence](https://confluence.systtech.ru/x/rgDk9)

### Критерии приемки

#### Сценарий 1: Создание и выгрузка документов
| Пользовательская история | Дано | Когда | Тогда |
|-------------------------|------|-------|-------|
| **Я, как оператор, хочу понимать какой заказ привел к сработке бонуса, чтобы иметь возможность проверять корректность начисления бонусов.** | Документы "Заказ" и "Начисление бонуса" созданы агентом в МТ<br>Данные выгружены из МТ в БД посредством Обмена данных | Документы "Заказ" и "Начисление бонуса" попадает в БД Чикаго | Документы "Начисление бонуса" будут удерживаться в очереди документов на период до 10 минут. |

#### Сценарий 2: Проставление документа-основания
| Дано | Когда | Тогда |
|------|-------|-------|
| В БД Чикаго есть документы Начисление бонуса, выгруженные из МТ и не отправлены в УС. | По расписанию срабатывает процедура проставления документа-основания в документ "Начисление бонуса".<br>Процедура отбирает неудаленные документы Начисления бонуса без внешнего кода, загруженные в БД сегодня | В период до 10 минут в документе "Начисление бонуса" проставляются:<br>1. "Документ-основание" - ссылка на соответствующий документ Заказ (1)<br>2. "Дата доставки" = Дата доставки из документа-основания<br>3. "Маршрут доставки" = Маршрут доставки из документа-основания<br>4. "Склад" = склад из документа-основания<br>5. "Отв.лицо" = отв.лицо, создавшее документ-основание |

#### Сценарий 3: Выгрузка в УС
| Дано | Когда | Тогда |
|------|-------|-------|
| Система проверяет наличие в БД Чикаго документов Заказ и Начисление бонуса по следующим условиям:<br>1. у документов Заказ и Начисление бонусов отсутствует внешний код<br>2. у документа "Начисление бонуса" проставлена ссылка на документ-основание<br>3. с момента поступления документа Заказ в БД Чикаго прошло 10 минут | Отобранные документы Начисление бонуса выгружаются в УС дистрибьютора | Отобранные документы Начисление бонуса выгружаются в УС дистрибьютора |

### Особенности реализации
1. **Данные о связке**: Берется из регистра акций (`rgPromoGoods.idBaseDoc`)
2. **Множественные записи**: Если в регистре присутствует более одной записи о документах-основаниях для "Начисления бонуса", система выбирает `idBaseDoc` с максимальным значением
3. **Множественные заказы**: Если на один документ "Начисление бонуса" есть несколько документов "Заказ", в документе "Начисление бонуса" проставляется ссылка на последний документ "Заказ"

## Техническое решение

### Архитектура решения
```
Мобильный Терминал (МТ)
    ↓
Создание заказа и начисления бонуса
    ↓
Обмен данными
    ↓
База данных Чикаго
    ↓
Процедура связывания документов
    ↓
Заполнение TargetDocumentChicagoId
    ↓
Выгрузка в УС дистрибьютора
```

### Компоненты системы
1. **Мобильный Терминал**: Создание документов "Заказ" и "Начисление бонуса"
2. **Обмен данными**: Синхронизация между МТ и БД Чикаго
3. **База данных Чикаго**: Хранение и обработка документов
4. **Процедура связывания**: Автоматическое связывание документов
5. **Интеграция с УС**: Выгрузка связанных документов

### Механизм связывания документов
```sql
-- Процедура проставления документа-основания
CREATE PROCEDURE sp_LinkBonusToOrder
AS
BEGIN
    -- Отбор неудаленных документов Начисления бонуса без внешнего кода
    -- загруженных в БД сегодня
    UPDATE BonusIssued 
    SET 
        TargetDocumentChicagoId = (
            SELECT TOP 1 idBaseDoc 
            FROM rgPromoGoods 
            WHERE BonusId = BonusIssued.Id 
            ORDER BY idBaseDoc DESC
        ),
        DeliveryDate = (
            SELECT DeliveryDate 
            FROM Orders 
            WHERE Id = (
                SELECT TOP 1 idBaseDoc 
                FROM rgPromoGoods 
                WHERE BonusId = BonusIssued.Id 
                ORDER BY idBaseDoc DESC
            )
        ),
        DeliveryRoute = (
            SELECT DeliveryRoute 
            FROM Orders 
            WHERE Id = (
                SELECT TOP 1 idBaseDoc 
                FROM rgPromoGoods 
                WHERE BonusId = BonusIssued.Id 
                ORDER BY idBaseDoc DESC
            )
        ),
        Warehouse = (
            SELECT Warehouse 
            FROM Orders 
            WHERE Id = (
                SELECT TOP 1 idBaseDoc 
                FROM rgPromoGoods 
                WHERE BonusId = BonusIssued.Id 
                ORDER BY idBaseDoc DESC
            )
        ),
        ResponsiblePerson = (
            SELECT ResponsiblePerson 
            FROM Orders 
            WHERE Id = (
                SELECT TOP 1 idBaseDoc 
                FROM rgPromoGoods 
                WHERE BonusId = BonusIssued.Id 
                ORDER BY idBaseDoc DESC
            )
        )
    WHERE 
        IsDeleted = 0 
        AND ExternalCode IS NULL 
        AND CAST(CreatedDate AS DATE) = CAST(GETDATE() AS DATE)
END
```

### Интеграция с УС
```csharp
public class BonusDocumentExporter
{
    public void ExportBonusDocumentsToUS()
    {
        // Отбор документов для выгрузки
        var bonusDocuments = GetBonusDocumentsForExport();
        
        foreach (var bonus in bonusDocuments)
        {
            // Проверка условий выгрузки
            if (ShouldExportBonusDocument(bonus))
            {
                // Выгрузка в УС
                ExportToUS(bonus);
            }
        }
    }
    
    private bool ShouldExportBonusDocument(BonusDocument bonus)
    {
        return bonus.ExternalCode == null 
            && bonus.TargetDocumentChicagoId != null 
            && bonus.CreatedDate.AddMinutes(10) <= DateTime.Now;
    }
}
```

## Оценка стоимости

### Детализация стоимости
- **Планируемая себестоимость разработки**: 40,557.73 руб
- **Планируемая себестоимость стабилизации**: 13,519.24 руб
- **Полная плановая стоимость**: 73,015.4 руб
- **Оценка себестоимости**: 2,088.72 руб
- **Адаптация плотности**: Бесплатно

### Экономические показатели
- **Стоимость для клиента**: 0 руб (бесплатная доработка)
- **Тип доработки**: Адаптация существующего решения
- **Сложность**: Средняя (адаптация готового решения)

## Реализация

### Этапы реализации
1. **Анализ требований** (Завершен)
   - Изучение решения АБИ
   - Анализ различий с проектом Атяшево
   - Оценка сложности адаптации

2. **Проектирование** (Завершен)
   - Адаптация архитектуры под Атяшево
   - Проектирование процедур связывания
   - Планирование интеграции с УС

3. **Разработка** (Завершен)
   - Реализация процедуры связывания документов
   - Адаптация под специфику Атяшево
   - Интеграция с существующей системой

4. **Тестирование** (Завершен)
   - Тестирование связывания документов
   - Проверка выгрузки в УС
   - UAT тестирование

5. **Демонстрация** (Завершена)
   - Демо для клиента на UAT-среде
   - Сбор обратной связи
   - Подтверждение готовности к продакшену

### Текущий статус
- **Разработка**: ✅ Завершена
- **Тестирование**: ✅ Завершено
- **Демонстрация**: ✅ Проведена
- **Статус**: ✅ Готово к проду
- **Пилот**: 🔄 До 30.09.2025

### Сроки
- **Планируемая дата завершения разработки**: 02.09.2025
- **Планируемая дата поставки**: 30.08.2025
- **Срок пилота**: До 30.09.2025

## Тестирование

### Сценарии тестирования
1. **Создание документов в МТ**:
   - Создание заказа с товарами
   - Срабатывание акции n+1
   - Создание документа "Начисление бонуса"

2. **Связывание документов**:
   - Выгрузка документов из МТ в БД Чикаго
   - Срабатывание процедуры связывания
   - Проверка заполнения полей

3. **Выгрузка в УС**:
   - Проверка условий выгрузки
   - Формирование файла BonusIssued
   - Отправка в УС дистрибьютора

### Критерии приемки
- ✅ Документы "Начисление бонуса" связываются с заказами
- ✅ Поле `TargetDocumentChicagoId` заполняется корректно
- ✅ Дополнительные поля заполняются из документа-основания
- ✅ Выгрузка в УС происходит по расписанию
- ✅ Файл BonusIssued содержит корректные ссылки

## Развертывание

### Требования к развертыванию
- **База данных Чикаго**: Обновление процедур связывания
- **Интеграция с УС**: Настройка выгрузки документов
- **Мониторинг**: Отслеживание работы процедур
- **Тестирование**: Проверка на тестовом окружении

### Процесс развертывания
1. **Подготовка окружения**:
   - Обновление БД Чикаго
   - Настройка интеграции с УС
   - Тестирование функциональности

2. **Пилотное развертывание**:
   - Развертывание на UAT-среде
   - Демонстрация клиенту
   - Сбор обратной связи

3. **Продуктивное развертывание**:
   - Развертывание на продакшене
   - Мониторинг работы
   - Поддержка пользователей

## Мониторинг и поддержка

### Ключевые метрики
- **Связывание документов**: Процент успешно связанных бонусов
- **Выгрузка в УС**: Количество выгруженных документов
- **Производительность**: Время выполнения процедур
- **Качество**: Процент корректных связей

### Поддержка
- **Документация**: Руководства по работе с системой
- **Мониторинг**: Отслеживание работы процедур
- **Обучение**: Поддержка операторов

## Риски и ограничения

### Технические риски
- **Производительность**: Влияние процедур связывания на БД
- **Интеграция**: Проблемы с выгрузкой в УС
- **Данные**: Корректность связывания документов

### Бизнес-риски
- **Принятие пользователями**: Сопротивление изменениям
- **Качество данных**: Точность связывания бонусов с заказами
- **Обучение**: Сложности в освоении новой функциональности

### Ограничения
- **Время связывания**: До 10 минут после создания документа
- **Условия выгрузки**: Строгие критерии отбора документов
- **Зависимости**: Требует корректной работы обмена данными

## Заключение

### Текущий статус
Проект технически завершен, проведена демонстрация клиенту, готов к развертыванию на продуктивном окружении.

### Достигнутые результаты
- **Функциональность**: Реализовано связывание бонусных документов с заказами
- **Интеграция**: Настроена выгрузка в УС дистрибьютора
- **Качество**: Обеспечена корректность связывания документов
- **Демонстрация**: Проведена успешная демонстрация клиенту

### Следующие шаги
1. **Пилот**: Развертывание на UAT-среде до 30.09.2025
2. **Мониторинг**: Отслеживание работы системы
3. **Поддержка**: Обеспечение стабильной работы
4. **Развитие**: Возможные доработки по результатам пилота

---
*Документ создан: 27.09.2025*  
*Версия: 1.0*  
*Статус: Готово к проду*
