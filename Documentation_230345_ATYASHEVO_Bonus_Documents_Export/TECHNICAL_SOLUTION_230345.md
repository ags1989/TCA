# Техническое решение: Атяшево. ТМА. Выгрузка документов оснований для бонусов в УС

## Обзор технического решения

### Цель
Реализация механизма автоматического связывания документов "Начисление бонуса" с документами-основаниями "Заказ" для корректной выгрузки в УС (Учетную Систему) дистрибьютора.

### Проблема
При срабатывании акции n+1 в файле `BonusIssued` не заполняется ссылка на заказ `TargetDocumentChicagoId`, из-за чего нет возможности подставить бонусный товар к нужному заказу средствами интеграции.

### Решение
Адаптация существующего решения с проекта АБИ для проекта Атяшево.

## Источники технической информации

### Основные документы
- **Требования**: [Confluence - Детальное описание доработки](https://confluence.systtech.ru/pages/viewpage.action?pageId=4049386833)
- **Решение АБИ**: [Confluence - Решение для АБИ](https://confluence.systtech.ru/pages/viewpage.action?pageId=927203376)
- **Оценка стоимости**: [Confluence - Оценка адаптации](https://confluence.systtech.ru/x/Ub1c8Q)

### Pull Request'ы
**Внимание**: Детальная техническая реализация находится в Pull Request'ах, которые не доступны через TFS API. Для получения полной технической информации необходимо:

1. Обратиться к команде разработки Foxtrot
2. Получить доступ к репозиторию кода
3. Найти PR, связанные с тикетом 230345
4. Изучить реальный код и архитектуру

## Функциональные требования

### User Story
**Я, как оператор, хочу понимать какой заказ привел к сработке бонуса, чтобы иметь возможность проверять корректность начисления бонусов.**

### Критерии приемки

#### Сценарий 1: Создание и выгрузка документов
| Дано | Когда | Тогда |
|------|-------|-------|
| Документы "Заказ" и "Начисление бонуса" созданы агентом в МТ<br>Данные выгружены из МТ в БД посредством Обмена данных | Документы "Заказ" и "Начисление бонуса" попадает в БД Чикаго | Документы "Начисление бонуса" будут удерживаться в очереди документов на период до 10 минут. |

#### Сценарий 2: Проставление документа-основания
| Дано | Когда | Тогда |
|------|-------|-------|
| В БД Чикаго есть документы Начисление бонуса, выгруженные из МТ и не отправлены в УС. | По расписанию срабатывает процедура проставления документа-основания в документ "Начисление бонуса".<br>Процедура отбирает неудаленные документы Начисления бонуса без внешнего кода, загруженные в БД сегодня | В период до 10 минут в документе "Начисление бонуса" проставляются:<br>1. "Документ-основание" - ссылка на соответствующий документ Заказ (1)<br>2. "Дата доставки" = Дата доставки из документа-основания<br>3. "Маршрут доставки" = Маршрут доставки из документа-основания<br>4. "Склад" = склад из документа-основания<br>5. "Отв.лицо" = отв.лицо, создавшее документ-основание |

#### Сценарий 3: Выгрузка в УС
| Дано | Когда | Тогда |
|------|-------|-------|
| Система проверяет наличие в БД Чикаго документов Заказ и Начисление бонуса по следующим условиям:<br>1. у документов Заказ и Начисление бонусов отсутствует внешний код<br>2. у документа "Начисление бонуса" проставлена ссылка на документ-основание<br>3. с момента поступления документа Заказ в БД Чикаго прошло 10 минут | Отобранные документы Начисление бонуса выгружаются в УС дистрибьютора | Отобранные документы Начисление бонуса выгружаются в УС дистрибьютора |

### Особенности реализации
1. **Данные о связке**: Берется из регистра акций (`rgPromoGoods.idBaseDoc`)
2. **Множественные записи**: Если в регистре присутствует более одной записи о документах-основаниях для "Начисления бонуса", система выбирает `idBaseDoc` с максимальным значением
3. **Множественные заказы**: Если на один документ "Начисление бонуса" есть несколько документов "Заказ", в документе "Начисление бонуса" проставляется ссылка на последний документ "Заказ"

## Технические детали (из TFS)

### Feature Flag
- **Название**: `ErwinExportedFileConfigurationByDistributorSettings`
- **Назначение**: Включение выгрузки бонусов в УС
- **Статус**: Включен на продакшене

### Сборки
- **Интеграционная сборка**: 3.6.203.7, 3.6.204.12
- **Маршрут на UAT**: 41002

### Результаты тестирования
По результатам тестирования (из комментариев в TFS):

1. **Создание заказа и бонуса**: Сделан заказ и распределён бонус на заказ
2. **Обмен данными**: Выполнен обмен данными, документы появляются в журнале
3. **Запись в БД**: Документы корректно записываются в БД и папку erwin до срабатывания джоба
4. **Срабатывание джоба**: После срабатывания джоба документы корректно связываются и выгружаются

**Важное замечание**: Разница во времени на последнем скриншоте была из-за того, что на окружении был выключен Feature Flag. После включения ФФ выгрузились все документы бонуса из очереди.

## Архитектура решения (общая схема)

```
Мобильный Терминал (МТ)
    ↓
Создание заказа и начисления бонуса
    ↓
Обмен данными
    ↓
База данных Чикаго
    ↓
Процедура связывания документов (джоб)
    ↓
Заполнение TargetDocumentChicagoId
    ↓
Выгрузка в УС дистрибьютора (через erwin)
```

## Компоненты системы

### 1. Мобильный Терминал
- Создание документов "Заказ" и "Начисление бонуса"
- Обмен данными с БД Чикаго

### 2. База данных Чикаго
- Хранение документов "Заказ" и "Начисление бонуса"
- Регистр связей `rgPromoGoods`
- Процедуры связывания документов

### 3. Система выгрузки
- Джоб для связывания документов
- Выгрузка в УС через erwin
- Feature Flag для управления

## Конфигурация

### Feature Flag
```xml
<!-- Включение выгрузки бонусов в УС -->
<add key="ErwinExportedFileConfigurationByDistributorSettings" value="true" />
```

### Настройки выгрузки
- **Интервал связывания**: До 10 минут после создания документа
- **Условия выгрузки**: Документы без внешнего кода, с проставленной связью
- **Задержка выгрузки**: 10 минут с момента создания заказа

## Мониторинг

### Ключевые метрики
- Количество связанных документов
- Время выполнения процедур связывания
- Успешность выгрузки в УС

### Логирование
- Логи выполнения джоба связывания
- Логи выгрузки в УС
- Ошибки при обработке документов

## Ограничения

### Временные ограничения
- Связывание документов: До 10 минут после создания
- Выгрузка в УС: Через 10 минут после создания заказа

### Условия связывания
- Документы должны быть созданы в один день
- Документы не должны иметь внешних кодов
- Должна существовать связь в регистре `rgPromoGoods`

## Зависимости

### Внешние системы
- **УС дистрибьютора**: Получатель выгруженных документов
- **erwin**: Система выгрузки файлов

### Внутренние системы
- **Мобильный Терминал**: Источник документов
- **База данных Чикаго**: Хранение и обработка
- **Система обмена данными**: Синхронизация МТ и БД

## Безопасность

### Права доступа
- Доступ к процедурам связывания
- Права на чтение/запись таблиц документов
- Доступ к системе выгрузки

### Валидация данных
- Проверка корректности связей
- Валидация данных перед выгрузкой
- Контроль целостности данных

## Резервное копирование

### Критичные данные
- Таблица документов "Заказ"
- Таблица документов "Начисление бонуса"
- Регистр связей `rgPromoGoods`
- Логи выполнения процедур

### Стратегия резервного копирования
- Ежедневное резервное копирование БД
- Резервное копирование логов
- Тестирование восстановления

## Поддержка и сопровождение

### Мониторинг
- Отслеживание выполнения джобов
- Мониторинг выгрузки в УС
- Контроль ошибок

### Обслуживание
- Регулярная очистка логов
- Оптимизация производительности
- Обновление документации

## Контакты

### Команда разработки
- **Команда**: Foxtrot
- **Проект**: Атяшево(Талина)
- **Ответственный**: Иванов Евгений

### Поддержка
- **Техническая поддержка**: [контакты]
- **Администратор БД**: [контакты]

---
**Важное замечание**: Данная документация основана на информации из TFS. Для получения детальной технической информации о реализации необходимо обратиться к Pull Request'ам в репозитории кода.

*Документ создан: 27.09.2025*  
*Версия: 1.0*  
*Статус: Готово к проду*
