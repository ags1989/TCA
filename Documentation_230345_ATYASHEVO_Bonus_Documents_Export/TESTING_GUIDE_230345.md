# Руководство по тестированию: Атяшево. ТМА. Выгрузка документов оснований для бонусов в УС

## Обзор тестирования

### Цель тестирования
Проверить корректность работы механизма связывания документов "Начисление бонуса" с документами-основаниями "Заказ" и выгрузки связанных документов в УС дистрибьютора.

### Область тестирования
- Создание документов в Мобильном Терминале
- Связывание документов в базе данных Чикаго
- Выгрузка связанных документов в УС
- Работа Feature Flag

## Тестовые сценарии (на основе реальных результатов)

### Сценарий 1: Создание заказа и начисления бонуса

#### Тест 1.1: Создание заказа в МТ
**Цель**: Проверить создание заказа с корректными данными

**Предусловия**:
- МТ настроен и подключен к системе
- Пользователь авторизован в системе
- Настроена акция n+1

**Шаги выполнения**:
1. Открыть МТ
2. Перейти в раздел "Заказы"
3. Создать новый заказ
4. Заполнить обязательные поля
5. Добавить товары, соответствующие условиям акции
6. Сохранить заказ

**Ожидаемый результат**:
- Заказ создан успешно
- При срабатывании акции автоматически создано начисление бонуса
- Документы готовы к выгрузке

**Критерии приемки**:
- ✅ Заказ создан с уникальным номером
- ✅ Начисление бонуса создано автоматически
- ✅ Связь между заказом и бонусом установлена

### Сценарий 2: Обмен данными

#### Тест 2.1: Выгрузка документов из МТ
**Цель**: Проверить выгрузку документов в БД Чикаго

**Предусловия**:
- Заказ и начисление бонуса созданы
- Настроен обмен данными между МТ и БД

**Шаги выполнения**:
1. Инициировать обмен данными
2. Дождаться завершения выгрузки
3. Проверить наличие документов в БД Чикаго
4. Проверить корректность данных

**Ожидаемый результат**:
- Документы успешно выгружены в БД
- Данные в БД соответствуют данным в МТ
- Документы появились в журнале

**Критерии приемки**:
- ✅ Документы выгружены в БД
- ✅ Данные соответствуют МТ
- ✅ Документы видны в журнале

### Сценарий 3: Связывание документов

#### Тест 3.1: Работа джоба связывания
**Цель**: Проверить автоматическое связывание документов

**Предусловия**:
- Документы выгружены в БД Чикаго
- Джоб связывания настроен и запущен

**Шаги выполнения**:
1. Дождаться срабатывания джоба связывания
2. Проверить заполнение поля `TargetDocumentChicagoId`
3. Проверить заполнение дополнительных полей:
   - Дата доставки
   - Маршрут доставки
   - Склад
   - Ответственное лицо

**Ожидаемый результат**:
- Поле `TargetDocumentChicagoId` заполнено
- Дополнительные поля заполнены из документа-основания
- Связь установлена корректно

**Критерии приемки**:
- ✅ `TargetDocumentChicagoId` заполнено
- ✅ Дополнительные поля заполнены
- ✅ Связь установлена корректно

### Сценарий 4: Выгрузка в УС

#### Тест 4.1: Выгрузка связанных документов
**Цель**: Проверить выгрузку документов в УС дистрибьютора

**Предусловия**:
- Документы связаны
- Feature Flag `ErwinExportedFileConfigurationByDistributorSettings` включен
- Прошло 10 минут с момента создания

**Шаги выполнения**:
1. Дождаться истечения 10 минут
2. Проверить работу джоба выгрузки
3. Проверить формирование файла в папке erwin
4. Проверить отправку в УС

**Ожидаемый результат**:
- Файл с бонусами сформирован в папке erwin
- Поле `TargetDocumentChicagoId` заполнено в файле
- Документы отправлены в УС

**Критерии приемки**:
- ✅ Файл сформирован в папке erwin
- ✅ `TargetDocumentChicagoId` заполнено
- ✅ Документы отправлены в УС

## Результаты реального тестирования

### Тестирование от 02.09.2025

#### Результаты (из TFS комментариев):

1. **Создание заказа и бонуса**:
   - ✅ Сделан заказ и распределён бонус на заказ
   - ✅ Связь между заказом и бонусом установлена

2. **Обмен данными**:
   - ✅ Выполнен обмен данными
   - ✅ Документы появились в журнале
   - ✅ Данные корректно записаны в БД

3. **Запись в БД и папку erwin**:
   - ✅ Документы записаны в БД до срабатывания джоба
   - ✅ Документы появились в папке erwin
   - ✅ Структура данных корректна

4. **Срабатывание джоба**:
   - ✅ Джоб сработал корректно
   - ✅ Документы связаны с заказами
   - ✅ `TargetDocumentChicagoId` заполнено
   - ✅ Дополнительные поля заполнены

#### Важные наблюдения:
- **Feature Flag**: Разница во времени была из-за выключенного Feature Flag
- **Восстановление**: После включения ФФ выгрузились все документы бонуса из очереди
- **Производительность**: Джоб работает стабильно

## UAT сценарии

### UAT 1: Полный цикл работы
**Цель**: Продемонстрировать полный цикл работы системы

**Участники**:
- Оператор (создание документов)
- Администратор (мониторинг)
- Представитель клиента (приемка)

**Сценарий**:
1. Оператор создает заказ в МТ
2. Система автоматически создает начисление бонуса
3. Документы выгружаются в БД Чикаго
4. Джоб связывает документы
5. Документы выгружаются в УС через erwin
6. Представитель клиента проверяет результат

**Критерии приемки**:
- ✅ Полный цикл выполнен
- ✅ Все этапы работают корректно
- ✅ Клиент подтверждает приемку

### UAT 2: Проверка Feature Flag
**Цель**: Проверить влияние Feature Flag на работу системы

**Сценарий**:
1. Выключить Feature Flag `ErwinExportedFileConfigurationByDistributorSettings`
2. Создать заказ и бонус
3. Проверить, что выгрузка не происходит
4. Включить Feature Flag
5. Проверить, что выгрузка возобновилась

**Критерии приемки**:
- ✅ При выключенном ФФ выгрузка не происходит
- ✅ При включенном ФФ выгрузка работает
- ✅ Накопленные документы выгружаются после включения ФФ

## Автоматизированное тестирование

### Unit тесты
```csharp
[TestClass]
public class BonusLinkingTests
{
    [TestMethod]
    public void LinkBonusToOrder_ShouldLinkCorrectly()
    {
        // Тест должен быть основан на реальном коде из PR
        // Обратиться к команде разработки за тестами
    }
    
    [TestMethod]
    public void ExportBonusToUS_ShouldExportCorrectly()
    {
        // Тест должен быть основан на реальном коде из PR
        // Обратиться к команде разработки за тестами
    }
}
```

**Внимание**: Реальные unit тесты находятся в Pull Request'ах. Для получения тестов обратитесь к команде разработки.

## Чек-лист тестирования

### Подготовка к тестированию
- [ ] UAT-среда настроена и готова
- [ ] Feature Flag `ErwinExportedFileConfigurationByDistributorSettings` включен
- [ ] Тестовые данные подготовлены
- [ ] Доступы к системе получены
- [ ] Маршрут 41002 настроен

### Функциональное тестирование
- [ ] Создание заказа в МТ
- [ ] Срабатывание акции n+1
- [ ] Выгрузка документов из МТ
- [ ] Связывание документов джобом
- [ ] Выгрузка в УС через erwin

### Тестирование Feature Flag
- [ ] Выключение ФФ
- [ ] Проверка остановки выгрузки
- [ ] Включение ФФ
- [ ] Проверка возобновления выгрузки

### UAT тестирование
- [ ] Демонстрация полного цикла
- [ ] Проверка работы с клиентом
- [ ] Подтверждение приемки

## Отчеты о тестировании

### Шаблон отчета о тестировании
```markdown
# Отчет о тестировании - Проект 230345

## Общая информация
- Дата тестирования: [дата]
- Тестировщик: [имя]
- Версия: [версия]
- Среда: UAT (маршрут 41002)

## Результаты тестирования
- Всего тестов: [количество]
- Пройдено: [количество]
- Провалено: [количество]
- Пропущено: [количество]

## Проверка Feature Flag
- Статус ФФ: [включен/выключен]
- Влияние на выгрузку: [описание]

## Найденные проблемы
1. [Описание проблемы]
   - Приоритет: Высокий/Средний/Низкий
   - Статус: Открыта/Исправлена/Закрыта

## Рекомендации
- [Рекомендации по улучшению]

## Заключение
- [Общее заключение о готовности]
```

## Контакты и поддержка

### Команда тестирования
- **Руководитель тестирования**: [имя, контакты]
- **Тестировщики**: [список]
- **Разработчики**: [список]

### Эскалация проблем
- **Критические проблемы**: [контакты]
- **Обычные проблемы**: [контакты]
- **Вопросы**: [контакты]

---
**Важное замечание**: Данное руководство основано на информации из TFS и реальных результатах тестирования. Для получения детальной информации о тестах обратитесь к Pull Request'ам в репозитории кода.

*Документ создан: 27.09.2025*  
*Версия: 1.0*  
*Статус: Готово к проду*
