# Руководство пользователя: Атяшево. ТМА. Выгрузка документов оснований для бонусов в УС

## Обзор функциональности

### Что это такое?
Система автоматического связывания документов "Начисление бонуса" с документами-основаниями "Заказ" для корректной выгрузки в УС (Учетную Систему) дистрибьютора.

### Зачем это нужно?
- **Проблема**: При срабатывании акции n+1 в файле `BonusIssued` не заполняется ссылка на заказ `TargetDocumentChicagoId`
- **Решение**: Автоматическое связывание документов позволяет корректно обрабатывать бонусные документы в УС
- **Результат**: Возможность подставить бонусный товар к нужному заказу средствами интеграции

### Кто использует?
- **Операторы**: Создают заказы и начисления бонусов в Мобильном Терминале
- **Администраторы**: Мониторят работу системы
- **Аналитики**: Проверяют корректность начисления бонусов

## Как это работает

### Общий процесс
1. **Создание заказа** в Мобильном Терминале
2. **Срабатывание акции** n+1 (автоматически)
3. **Создание начисления бонуса** (автоматически)
4. **Выгрузка документов** из МТ в БД Чикаго
5. **Связывание документов** (автоматически, до 10 минут)
6. **Выгрузка в УС** дистрибьютора через erwin

### Временные рамки
- **Связывание документов**: До 10 минут после создания
- **Выгрузка в УС**: Через 10 минут после создания документа
- **Периодичность проверки**: Каждые 5 минут

## Работа с системой

### Для операторов

#### Создание заказа
1. **Откройте Мобильный Терминал**
2. **Перейдите в раздел "Заказы"**
3. **Нажмите "Создать заказ"**
4. **Заполните обязательные поля**:
   - Номер заказа (автоматически)
   - Дата заказа (текущая дата)
   - Дата доставки
   - Маршрут доставки
   - Склад
   - Ответственное лицо
5. **Добавьте товары в заказ**
6. **Сохраните заказ**

#### Проверка срабатывания акции
1. **После сохранения заказа** система автоматически проверяет условия акции
2. **При выполнении условий** создается документ "Начисление бонуса"
3. **Проверьте уведомления** о создании начисления бонуса

#### Выгрузка документов
1. **Документы выгружаются автоматически** при синхронизации с БД Чикаго
2. **Проверьте статус выгрузки** в разделе "Обмен данными"
3. **Дождитесь завершения** процесса выгрузки

### Для администраторов

#### Мониторинг связывания документов
1. **Откройте SQL Server Management Studio**
2. **Подключитесь к базе данных Чикаго**
3. **Выполните запрос**:
```sql
SELECT 
    COUNT(*) as TotalBonusDocuments,
    COUNT(TargetDocumentChicagoId) as LinkedDocuments,
    COUNT(*) - COUNT(TargetDocumentChicagoId) as UnlinkedDocuments
FROM BonusIssued 
WHERE IsDeleted = 0 
AND CAST(CreatedDate AS DATE) = CAST(GETDATE() AS DATE);
```

#### Проверка джоба
1. **Откройте SQL Server Agent**
2. **Найдите джоб** `LinkBonusToOrder_Job`
3. **Проверьте статус** выполнения джоба
4. **При необходимости** запустите джоб вручную

#### Управление Feature Flag
1. **Проверьте статус** Feature Flag `ErwinExportedFileConfigurationByDistributorSettings`
2. **При необходимости** включите/выключите ФФ
3. **Проверьте влияние** на выгрузку документов

### Для аналитиков

#### Проверка корректности начисления бонусов
1. **Откройте отчет по бонусам** в УС
2. **Проверьте наличие** поля `TargetDocumentChicagoId`
3. **Сопоставьте бонусы** с соответствующими заказами
4. **Проверьте корректность** данных

#### Анализ статистики
1. **Используйте запросы** для анализа связывания документов
2. **Проверьте производительность** системы
3. **Анализируйте ошибки** при связывании

## Часто задаваемые вопросы (FAQ)

### Q: Почему документ "Начисление бонуса" не связывается с заказом?
**A**: Возможные причины:
- Документы созданы в разные дни
- Один из документов уже имеет внешний код
- Документ был удален
- Прошло менее 10 минут с момента создания

**Решение**: Проверьте условия связывания и подождите до 10 минут.

### Q: Как долго ждать связывания документов?
**A**: Связывание происходит автоматически в течение 10 минут после создания документа. Проверка выполняется каждые 5 минут.

### Q: Что делать, если связывание не произошло?
**A**: 
1. Проверьте логи системы
2. Убедитесь, что документы созданы в один день
3. Проверьте, что документы не имеют внешних кодов
4. Обратитесь к администратору системы

### Q: Можно ли связать документы вручную?
**A**: Нет, связывание происходит только автоматически. Ручное связывание не предусмотрено.

### Q: Как проверить, что документы выгружены в УС?
**A**: 
1. Проверьте поле `ExternalCode` в таблице `BonusIssued`
2. Если поле заполнено значением `EXPORTED_[ID]`, документ выгружен
3. Проверьте папку erwin на наличие файлов

### Q: Что означает ошибка в логах?
**A**: Ошибки в логах указывают на проблемы при связывании документов. Обратитесь к администратору системы для анализа конкретной ошибки.

### Q: Можно ли изменить настройки связывания?
**A**: Настройки связывания можно изменить только администратором системы. Обратитесь к администратору для изменения параметров.

### Q: Что такое Feature Flag?
**A**: Feature Flag `ErwinExportedFileConfigurationByDistributorSettings` управляет выгрузкой бонусов в УС. При выключенном ФФ выгрузка не происходит.

## Решение проблем

### Проблема 1: Документы не связываются

#### Симптомы
- Документы "Начисление бонуса" остаются без связи с заказами
- Поле `TargetDocumentChicagoId` не заполняется

#### Диагностика
1. **Проверьте условия связывания**:
```sql
SELECT 
    bi.Id,
    bi.BonusNumber,
    bi.CreatedDate,
    bi.ExternalCode,
    bi.TargetDocumentChicagoId
FROM BonusIssued bi
WHERE bi.IsDeleted = 0 
AND bi.ExternalCode IS NULL 
AND bi.TargetDocumentChicagoId IS NULL
AND CAST(bi.CreatedDate AS DATE) = CAST(GETDATE() AS DATE);
```

2. **Проверьте наличие заказов**:
```sql
SELECT 
    o.Id,
    o.OrderNumber,
    o.CreatedDate,
    o.ExternalCode
FROM Orders o
WHERE o.IsDeleted = 0 
AND o.ExternalCode IS NULL
AND CAST(o.CreatedDate AS DATE) = CAST(GETDATE() AS DATE);
```

3. **Проверьте регистр связей**:
```sql
SELECT 
    pg.BonusId,
    pg.idBaseDoc,
    bi.BonusNumber,
    o.OrderNumber
FROM rgPromoGoods pg
LEFT JOIN BonusIssued bi ON pg.BonusId = bi.Id
LEFT JOIN Orders o ON pg.idBaseDoc = o.Id
WHERE CAST(pg.CreatedDate AS DATE) = CAST(GETDATE() AS DATE);
```

#### Решение
1. **Убедитесь, что документы созданы в один день**
2. **Проверьте, что документы не имеют внешних кодов**
3. **Проверьте наличие связей в регистре `rgPromoGoods`**
4. **Запустите джоб связывания вручную**:
```sql
EXEC sp_LinkBonusToOrder;
```

### Проблема 2: Feature Flag выключен

#### Симптомы
- Документы не выгружаются в УС
- В папке erwin нет файлов

#### Диагностика
1. **Проверьте статус Feature Flag**:
```sql
SELECT * FROM Settings 
WHERE Key = 'ErwinExportedFileConfigurationByDistributorSettings';
```

2. **Проверьте настройки приложения**

#### Решение
1. **Включите Feature Flag**:
```xml
<add key="ErwinExportedFileConfigurationByDistributorSettings" value="true" />
```

2. **Перезапустите приложение**
3. **Проверьте выгрузку документов**

### Проблема 3: Медленная работа системы

#### Симптомы
- Джоб связывания выполняется долго
- Система работает медленно

#### Диагностика
1. **Проверьте производительность джоба**:
```sql
SELECT 
    ProcessDate,
    ProcessedCount,
    DATEDIFF(second, ProcessDate, GETDATE()) as SecondsAgo
FROM LinkBonusLog
WHERE ProcessDate >= DATEADD(hour, -1, GETDATE())
ORDER BY ProcessDate DESC;
```

2. **Проверьте использование ресурсов**:
```sql
SELECT 
    COUNT(*) as TotalDocuments,
    COUNT(TargetDocumentChicagoId) as LinkedDocuments
FROM BonusIssued
WHERE IsDeleted = 0;
```

#### Решение
1. **Проверьте индексы** на таблицах
2. **Оптимизируйте запросы** в процедурах
3. **Увеличьте интервал** между запусками джоба
4. **Обратитесь к администратору системы**

## Мониторинг и отчеты

### Ключевые показатели

#### 1. Статистика связывания
- **Общее количество** документов "Начисление бонуса"
- **Количество связанных** документов
- **Процент связывания** документов
- **Время выполнения** процедур

#### 2. Качество данных
- **Количество ошибок** при связывании
- **Процент успешных** операций
- **Время обработки** документов

#### 3. Производительность системы
- **Среднее время** выполнения процедур
- **Максимальное время** выполнения
- **Количество обработанных** документов за период

### Отчеты

#### Ежедневный отчет
```sql
SELECT 
    CAST(ProcessDate AS DATE) as ProcessDate,
    COUNT(*) as TotalRuns,
    SUM(ProcessedCount) as TotalProcessed,
    AVG(ProcessedCount) as AvgProcessed,
    SUM(CASE WHEN Success = 1 THEN 1 ELSE 0 END) as SuccessfulRuns,
    SUM(CASE WHEN Success = 0 THEN 1 ELSE 0 END) as FailedRuns
FROM LinkBonusLog
WHERE ProcessDate >= DATEADD(day, -1, GETDATE())
GROUP BY CAST(ProcessDate AS DATE);
```

#### Еженедельный отчет
```sql
SELECT 
    DATEPART(week, ProcessDate) as WeekNumber,
    COUNT(*) as TotalRuns,
    SUM(ProcessedCount) as TotalProcessed,
    AVG(ProcessedCount) as AvgProcessed,
    SUM(CASE WHEN Success = 1 THEN 1 ELSE 0 END) * 100.0 / COUNT(*) as SuccessRate
FROM LinkBonusLog
WHERE ProcessDate >= DATEADD(week, -4, GETDATE())
GROUP BY DATEPART(week, ProcessDate)
ORDER BY WeekNumber;
```

## Контакты и поддержка

### Команда поддержки
- **Техническая поддержка**: [контакты]
- **Администратор БД**: [контакты]
- **Администратор системы**: [контакты]

### Время работы поддержки
- **Понедельник - Пятница**: 9:00 - 18:00
- **Суббота**: 10:00 - 16:00
- **Воскресенье**: Выходной

### Способы связи
- **Email**: support@company.com
- **Телефон**: +7 (XXX) XXX-XX-XX
- **Внутренний чат**: [ссылка]

### Эскалация проблем
- **Критические проблемы**: Немедленно
- **Обычные проблемы**: В течение 4 часов
- **Вопросы**: В течение 24 часов

---
*Документ создан: 27.09.2025*  
*Версия: 1.0*  
*Статус: Готово к проду*
