# Руководство по тестированию: АкваТрейд. В МТ разделить долги ТТ по маршрутам

## Обзор тестирования

### Цель тестирования
Проверить корректность работы функционала разделения долгов торговых точек по маршрутам в разрезе фокусных групп.

### Области тестирования
1. **Загрузка данных из УС** - корректность репликации данных о лимитах
2. **Выгрузка в МТ** - передача данных в мобильные терминалы
3. **Отображение в МТ** - корректность отображения долгов по маршрутам
4. **Бизнес-логика** - проверка лимитов и стоп-листов
5. **Интеграция** - взаимодействие всех компонентов системы

## Подготовка к тестированию

### Требования к окружению
- **Версия МТ**: 3.6.205.4 или выше
- **Окружение**: UAT (User Acceptance Testing)
- **Доступ к БД**: Чикаго, МТ
- **Тестовые данные**: Подготовлены заранее

### Тестовые данные

#### Данные для фокусных групп
```xml
<REFERENCES>
  <FocusGroups>
    <Group>
      <outercode>13783_FG1234</outercode>
      <Outlet>13783</Outlet>
      <FG>FG1234</FG>
      <CreditLimit>100000</CreditLimit>
      <IsInStopList>0</IsInStopList>
      <CreditDeadLine>20</CreditDeadLine>
      <classifier6code>Причина1</classifier6code>
    </Group>
    <Group>
      <outercode>13784_FG1234</outercode>
      <Outlet>13784</Outlet>
      <FG>FG1234</FG>
      <CreditLimit>50000</CreditLimit>
      <IsInStopList>1</IsInStopList>
      <CreditDeadLine>15</CreditDeadLine>
      <classifier6code>Причина2</classifier6code>
    </Group>
  </FocusGroups>
</REFERENCES>
```

#### Тестовые маршруты
- **Маршрут 1000001** - Фокусная группа FG1234
- **Маршрут 1000002** - Фокусная группа FG5678
- **Маршрут 1000003** - Без фокусной группы

## Тест-кейсы

### TC-001: Загрузка данных из УС

#### Описание
Проверка корректности загрузки данных о лимитах кредита из УС в Чикаго.

#### Предусловия
- УС сформировала файл с данными о лимитах
- Репликация настроена и запущена
- БД Чикаго доступна

#### Шаги выполнения
1. Разместить файл `references.xml` в папку обмена
2. Запустить репликацию с параметрами:
   ```
   -action=get -det=synchronization -group=ImportRefs -contextNodeID=11
   ```
3. Проверить логи репликации
4. Проверить данные в БД

#### Ожидаемый результат
- Данные успешно загружены в таблицу `refOutletFocusGroups`
- В логах нет ошибок
- Количество записей соответствует тестовым данным

#### Проверочные запросы
```sql
-- Проверка загруженных данных
SELECT * FROM refOutletFocusGroups;

-- Проверка логов изменений
SELECT * FROM dbo.v_LogDataChange 
WHERE ChangeDate >= '20250911' 
  AND AppName = 'ST-Replication' 
ORDER BY ChangeDate;
```

### TC-002: Выгрузка данных в МТ

#### Описание
Проверка корректности выгрузки данных о лимитах в мобильный терминал.

#### Предусловия
- Данные загружены в Чикаго (TC-001)
- МТ версии 3.6.205.4+
- Агент авторизован в системе

#### Шаги выполнения
1. Войти в МТ под учетной записью агента
2. Выполнить обмен данными (полную загрузку)
3. Проверить данные в локальной БД МТ
4. Проверить корректность фильтрации по фокусной группе

#### Ожидаемый результат
- Агент получает только данные своей фокусной группы
- Поля `LimitCredit`, `IsInStopList`, `CreditDeadline`, `idClassifier6` заполнены
- Данные соответствуют загруженным в Чикаго

#### Проверочные запросы
```sql
-- Проверка данных в МТ (stmobile.db3)
SELECT 
    Outlet,
    LimitCredit,
    IsInStopList,
    CreditDeadline,
    idClassifier6
FROM refOutlets 
WHERE Outlet IN (13783, 13784);
```

### TC-003: Отображение долгов в разрезе маршрута

#### Описание
Проверка корректности отображения долгов торговых точек в разрезе маршрута агента.

#### Предусловия
- Данные выгружены в МТ (TC-002)
- В БД есть задолженности с привязкой к маршрутам
- Функциональный флаг "Задолженности, лимиты и срок кредита в разрезах фокусных групп" включен

#### Шаги выполнения
1. Открыть отчет "Долги" в МТ
2. Проверить отображение долгов
3. Открыть карточку торговой точки
4. Проверить вкладку "Лимиты"

#### Ожидаемый результат
- В отчете "Долги" отображаются только долги по маршруту агента
- В карточке ТТ отображается долг в разрезе фокусной группы
- Данные соответствуют реальной задолженности

### TC-004: Проверка лимитов кредита

#### Описание
Проверка корректности работы лимитов кредита в разрезе фокусной группы.

#### Предусловия
- Данные о лимитах загружены (TC-001, TC-002)
- У торговой точки есть задолженность
- Агент пытается создать заказ

#### Тест-кейс 4.1: Превышение лимита
1. Выбрать торговую точку с превышенным лимитом кредита
2. Попытаться создать заказ
3. Проверить сообщение об ошибке

**Ожидаемый результат**: Выводится сообщение "Превышена сумма кредита"

#### Тест-кейс 4.2: Лимит не превышен
1. Выбрать торговую точку с непревзойденным лимитом
2. Создать заказ
3. Проверить успешное создание

**Ожидаемый результат**: Заказ создается без ошибок

### TC-005: Работа стоп-листа

#### Описание
Проверка корректности работы стоп-листа торговых точек в разрезе фокусных групп.

#### Предусловия
- Данные о стоп-листе загружены (TC-001, TC-002)
- Торговая точка находится в стоп-листе для фокусной группы агента

#### Шаги выполнения
1. Выбрать торговую точку из стоп-листа
2. Попытаться создать заказ
3. Проверить сообщение об ошибке
4. Открыть карточку ТТ
5. Проверить отображение причины постановки в стоп-лист

#### Ожидаемый результат
- Выводится сообщение "ТТ находится в стоп-листе"
- В карточке ТТ отображается причина постановки в стоп-лист
- Создание заказа запрещено

### TC-006: Отключение функционального флага

#### Описание
Проверка работы системы при отключенном функциональном флаге.

#### Предусловия
- Функциональный флаг "Задолженности, лимиты и срок кредита в разрезах фокусных групп" отключен
- Данные загружены в систему

#### Шаги выполнения
1. Отключить функциональный флаг
2. Выполнить полную загрузку в МТ
3. Проверить отображение долгов
4. Проверить работу стоп-листа

#### Ожидаемый результат
- Работает серийная логика (без разделения по фокусным группам)
- В отчете "Долги" отображается вся задолженность
- В карточке ТТ отображается общий долг
- Стоп-лист работает по серийной логике

### TC-007: Обработка граничных случаев

#### Описание
Проверка работы системы в граничных случаях.

#### Тест-кейс 7.1: idRoute = 0
1. Настроить данные с `idRoute = 0`
2. Выполнить тестирование по TC-002, TC-003

**Ожидаемый результат**: Система работает корректно, используя серийную логику

#### Тест-кейс 7.2: Отсутствие данных о фокусной группе
1. Удалить данные о фокусной группе для торговой точки
2. Проверить работу системы

**Ожидаемый результат**: Система работает по серийной логике

#### Тест-кейс 7.3: Несколько фокусных групп для одной ТТ
1. Настроить данные с несколькими фокусными группами для одной ТТ
2. Проверить корректность отображения

**Ожидаемый результат**: Отображаются данные только для фокусной группы агента

## Автоматизированное тестирование

### Скрипты проверки БД
```sql
-- Проверка целостности данных
SELECT 
    COUNT(*) as total_records,
    COUNT(DISTINCT Outlet) as unique_outlets,
    COUNT(DISTINCT FG) as unique_focus_groups
FROM refOutletFocusGroups;

-- Проверка корректности лимитов
SELECT 
    FG,
    COUNT(*) as outlets_count,
    AVG(CreditLimit) as avg_credit_limit,
    SUM(CASE WHEN IsInStopList = 1 THEN 1 ELSE 0 END) as stop_list_count
FROM refOutletFocusGroups
GROUP BY FG;
```

### Скрипты проверки МТ
```sql
-- Проверка данных в МТ
SELECT 
    COUNT(*) as total_outlets,
    COUNT(CASE WHEN LimitCredit IS NOT NULL THEN 1 END) as outlets_with_limits,
    COUNT(CASE WHEN IsInStopList = 1 THEN 1 END) as stop_list_outlets
FROM refOutlets;
```

## Критерии приемки

### Функциональные критерии
- ✅ Все тест-кейсы TC-001 - TC-007 пройдены успешно
- ✅ Данные корректно загружаются из УС в Чикаго
- ✅ Выгрузка в МТ работает без ошибок
- ✅ Долги отображаются в разрезе маршрута агента
- ✅ Лимиты кредита работают корректно
- ✅ Стоп-лист функционирует правильно
- ✅ Отключение функционального флага работает

### Производительностные критерии
- ✅ Время загрузки данных < 2 минут
- ✅ Время отклика МТ < 2 секунд
- ✅ Объем передаваемых данных в пределах нормы

### Критерии качества
- ✅ Нет критических ошибок в логах
- ✅ Данные не теряются при обработке
- ✅ Система стабильно работает в течение тестового периода

## Отчетность

### Формат отчета о тестировании
```
Тест-кейс: TC-XXX
Статус: ПРОЙДЕН/НЕ ПРОЙДЕН
Время выполнения: XX:XX
Ошибки: [список ошибок]
Комментарии: [дополнительная информация]
```

### Логи для анализа
- Логи репликации: `Logs\Rpl_{NodeID}_STRplShuttle-Test_rpl_Core.utf8.dll.txt`
- Логи МТ: `logs\app.log`
- Логи БД: `dbo.v_LogDataChange`

## План тестирования

### Этап 1: Подготовка (1 день)
- Настройка тестового окружения
- Подготовка тестовых данных
- Проверка доступности всех компонентов

### Этап 2: Функциональное тестирование (2 дня)
- Выполнение тест-кейсов TC-001 - TC-005
- Документирование результатов
- Исправление найденных ошибок

### Этап 3: Интеграционное тестирование (1 день)
- Выполнение тест-кейсов TC-006 - TC-007
- Проверка взаимодействия компонентов
- Нагрузочное тестирование

### Этап 4: Приемочное тестирование (1 день)
- Финальная проверка всех функций
- Подготовка отчета о тестировании
- Подписание акта приемки

## Контакты

- **Ответственный за тестирование**: Макаренко Илья
- **Техническая поддержка**: Сунко Марина
- **Координатор**: Авдеева Галина

---
*Документ создан: 26.09.2025*  
*Версия: 1.0*  
*Статус: Готов к использованию*
