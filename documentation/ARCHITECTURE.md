# Архитектура системы

## Обзор архитектуры

Система реализует разделение долгов торговых точек по маршрутам в рамках проекта АкваТрейд. Архитектура построена на принципах репликации данных между учетной системой (УС), центральной базой данных (Чикаго) и мобильными терминалами (МТ).

## Компоненты системы

### 1. Учетная система (УС)
- **Назначение**: Источник данных о задолженностях и лимитах кредита
- **Функции**: 
  - Выгрузка данных о задолженностях с идентификатором маршрута (idroute)
  - Формирование данных о лимитах кредита в разрезе фокусных групп
  - Выгрузка классификатора "Тип Фокуса" для оргпозиций

### 2. Центральная база данных (Чикаго)
- **Назначение**: Центральное хранилище данных
- **Функции**:
  - Прием и обработка данных из УС
  - Формирование индивидуальных таблиц для фокусных групп
  - Выгрузка данных в МТ с учетом маршрута агента

### 3. Система репликации (Replication.Shuttle)
- **Версия**: 3.6.205.4
- **Назначение**: Синхронизация данных между компонентами
- **Функции**:
  - Загрузка данных из УС в Чикаго
  - Выгрузка данных из Чикаго в МТ
  - Обработка изменений данных из МТ

### 4. Мобильный терминал (МТ)
- **Назначение**: Интерфейс для торговых агентов
- **Функции**:
  - Отображение долгов в разрезе маршрута
  - Контроль лимитов кредита по фокусным группам
  - Управление стоп-листом торговых точек

## Потоки данных

### 1. Загрузка данных из УС в Чикаго

```
УС → Replication.Shuttle → Чикаго
```

**Процесс:**
1. УС формирует файл с данными о задолженностях
2. Replication.Shuttle обрабатывает файл через расписание
3. Данные загружаются в таблицу `rgReceivables`
4. Формируются индивидуальные таблицы для фокусных групп

### 2. Выгрузка данных в МТ

```
Чикаго → Replication.Shuttle → МТ
```

**Процесс:**
1. Агент выполняет обмен данными в МТ
2. Replication.Shuttle формирует выгрузку с учетом маршрута агента
3. Данные загружаются в локальную БД МТ
4. МТ отображает данные в разрезе маршрута

### 3. Обратная синхронизация

```
МТ → Replication.Shuttle → Чикаго
```

**Процесс:**
1. Изменения в МТ передаются через Replication.Shuttle
2. Триггеры предотвращают перезапись индивидуальных данных
3. Данные обновляются в соответствующих таблицах

## Ключевые таблицы

### rgReceivables
- **Назначение**: Регистр задолженностей
- **Ключевые поля**: idroute, сумма задолженности, контрагент

### refOutletFocusGroups
- **Назначение**: Индивидуальная таблица лимитов по фокусным группам
- **Ключевые поля**: outercode, FG, CreditLimit, IsInStopList, CreditDeadline

### refOutlets
- **Назначение**: Серийная таблица торговых точек
- **Ключевые поля**: LimitCredit, IsInStopList, idClassifier6, CreditDeadline

### refOutercodes
- **Назначение**: Внешние коды для связи с УС
- **Ключевые поля**: outercode, внутренний ID

## Функциональные флаги

### ФФ "Задолженности, лимиты и срок кредита в разрезах фокусных групп"
- **Включен**: Работает индивидуальная логика разделения по фокусным группам
- **Выключен**: Работает серийная логика (общие данные для всех агентов)

## Бизнес-логика

### 1. Контроль лимитов кредита
- При создании заказа проверяется превышение лимита в разрезе фокусной группы
- При превышении выводится сообщение "Превышена сумма кредита"
- Создание заказа блокируется

### 2. Стоп-лист торговых точек
- ТТ может быть в стоп-листе для одной фокусной группы и не в стоп-листе для другой
- При попытке работы с ТТ в стоп-листе выводится сообщение "ТТ находится в стоп-листе"
- Отображается причина постановки в стоп-лист (классификатор №6)

### 3. Отображение задолженностей
- В карточке ТТ показывается задолженность только в разрезе маршрута агента
- В отчете "Долги" отображаются только релевантные для агента данные
- Документ ПКО формируется только с документами агента

## Технические особенности

### 1. Идентификация маршрута
- Используется поле `idroute` из регистра задолженностей
- Связь с маршрутом агента через `employeecode`

### 2. Классификация фокусных групп
- Классификатор "Тип Фокуса" на уровне оргпозиции
- Значения: Universal (водная группа), Bestseller, Bestseller Bere

### 3. Обработка изменений
- Триггеры предотвращают перезапись индивидуальных данных из МТ
- Использование `app_name()` и `context_info()` для определения источника изменений

## Масштабируемость

### 1. Производительность
- Индексы на ключевых полях для быстрого поиска
- Пакетная обработка данных при репликации

### 2. Надежность
- Транзакционная обработка критических операций
- Логирование всех изменений данных

### 3. Мониторинг
- Логи репликации для отслеживания процесса синхронизации
- Мониторинг производительности запросов
