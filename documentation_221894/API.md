# API и интерфейсы "Транзитные заказы"

## Обзор

Система "Транзитные заказы" использует API для работы с дополнительными атрибутами в мобильном терминале и интеграции с внешними системами.

## API работы с дополнительными атрибутами (из TFS)

### 1. Получение иерархии атрибутов

**Метод**: `getTransitOrderAttributes(parentId)`

**Описание** (из User Story 227560):
- Методы получения данных из инди-таблицы со списком атрибутов и их иерархической связью
- При выборе значения ("Да") запускается логика смены отображаемого списка
- Каждый новый шаг отображает следующую группу атрибутов

**Параметры**:
- `parentId` (int, optional) - ID родительского атрибута (null для корневого уровня)

**Возвращаемые данные**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "parentId": null,
      "name": "Розничная ЛД",
      "description": "Отгрузка через розничную лицензию ЛД",
      "level": 1,
      "isActive": true,
      "hasChildren": true
    }
  ]
}
```

### 2. Получение результирующего значения

**Метод**: `getTransitOrderResult(selectedAttributes)`

**Описание** (из User Story 227560):
- Методы получения результирующего значения
- Циклическая итерация по шагам до достижения конечного значения

**Параметры**:
- `selectedAttributes` (array) - Массив выбранных атрибутов

**Возвращаемые данные**:
```json
{
  "success": true,
  "result": {
    "licenseType": "Розничная ЛД",
    "prefix": "V",
    "isRetail": true,
    "storeName": null
  }
}
```

### 3. Сохранение выбранных атрибутов

**Метод**: `saveTransitOrderAttributes(orderId, attributes)`

**Описание** (из User Story 227560):
- Сохранение соответствующих полей документа через API

**Параметры**:
- `orderId` (int) - ID заказа
- `attributes` (object) - Объект с выбранными атрибутами

**Пример запроса**:
```json
{
  "orderId": 12345,
  "attributes": {
    "licenseType": "Розничная ЛД",
    "prefix": "V",
    "isRetail": true,
    "storeName": null
  }
}
```

**Возвращаемые данные**:
```json
{
  "success": true,
  "message": "Атрибуты успешно сохранены",
  "orderId": 12345
}
```

### 4. Валидация выбора

**Метод**: `validateTransitOrderSelection(attributes)`

**Описание** (из ошибки 231567):
- Проверка корректности выбранных атрибутов
- Валидация доступности кнопки "Сохранить"

**Параметры**:
- `attributes` (object) - Объект с выбранными атрибутами

**Возвращаемые данные**:
```json
{
  "isValid": true,
  "canSave": true,
  "errors": [],
  "warnings": []
}
```

## Интеграция с 1С (из TFS)

### Передача параметров транзитного заказа

**Параметры для передачи** (из основного запроса 221894):
- Тип лицензии (оптовая/розничная)
- Выбранный магазин (для розничных магазинов)
- Префикс заказа
- Признак "Это розница" (для розничной лицензии ЛД)
- Дата отгрузки (минус один день от даты отгрузки товара клиенту)

## Реализованные сервисы (из TFS)

### 1. FormRulesService

**Функционал** (из Backlog Item 229881):
- Создание фабрики правил (FormRulesFactory)
- Сервис по работе с правилами (FormRulesService)
- Модель представления зависимых полей (TreeToConstructorAdapter)

### 2. Логика валидации

**Требования** (из ошибки 231567):
- При открытии формы выбора доп.атрибутов форма запоминает значения по дефолту
- Если выбранные значения будут совпадать со значениями по дефолту, кнопка "Сохранить" не будет доступна
- Выполняется проверка, все ли доступные значения формы заполнены
- Кнопка "Сохранить" будет доступна только при условии, что все доступные значения заполнены, а также значения не равны значениям по умолчанию

## Обработка ошибок (из TFS)

### Исправленные проблемы

**Ошибка 231567** - Кнопка "Сохранить" в окне Тип лицензии:
- Добавлена логика на доступность кнопки "Сохранить"
- При открытии формы выбора доп.атрибутов форма запоминает значения по дефолту
- Если выбранные значения будут совпадать со значениями по дефолту, кнопка "Сохранить" не будет доступна

**Ошибка 231570** - Логика возвращения значений:
- Реализована логика возвращения значений по умолчанию при изменении значения Транзитного заказа с "Да" на "Нет"

**Ошибка 231484** - Лишняя строка с нулями:
- Добавлена фильтрация в выгрузку ХП для исключения нулевых значений
