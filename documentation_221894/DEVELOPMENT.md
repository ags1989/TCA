# Руководство разработчика "Транзитные заказы"

## Обзор

Данное руководство предназначено для разработчиков, работающих с системой "Транзитные заказы" в мобильном терминале (МТ) системы Ладога.

## Компоненты системы (из TFS)

### Реализованные компоненты

1. **Component-libs** - Модификация конструктора форм
2. **Shared-libs** - Библиотека для конструктора форм
3. **FormRulesFactory** - Фабрика правил
4. **FormRulesService** - Сервис по работе с правилами
5. **TreeToConstructorAdapter** - Модель представления зависимых полей

### Технологический стек (из TFS)

- **Мобильный терминал**: Версия 5.2.16
- **Chicago DB**: Версия 3.6.201.4
- **Replication.Shuttle**: Версия 3.6.205.4
- **База данных**: SQL Server (Chicago), SQLite (МТ)

## Требования к разработке (из TFS)

### 1. Точка расширения редактирования доп. атрибута

**Реализация скрипта** (из User Story 227560):
- Методы получения данных из инди-таблицы со списком атрибутов и их иерархической связью
- Методы получения результирующего значения
- Реализация кастомного компонента ввода выбора значения
- Обработка выбора значения пользователем:
  - При выборе значения ("Да") запускается логика смены отображаемого списка
  - Каждый новый шаг отображает следующую группу атрибутов
  - Циклическая итерация по шагам до достижения конечного значения

### 2. Сохранение полей документа

**API редактирования заголовочной части документа заказ** (из User Story 227560):
- Сохранение соответствующих полей документа через API

### 3. FormRulesService

**Реализованный сервис** (из Backlog Item 229881):
- Создание фабрики правил (FormRulesFactory)
- Сервис по работе с правилами (FormRulesService)
- Модель представления зависимых полей (TreeToConstructorAdapter)

### 4. Логика валидации (из TFS)

**Требования к валидации** (из ошибки 231567):
- При открытии формы выбора доп.атрибутов форма запоминает значения по дефолту
- Если выбранные значения будут совпадать со значениями по дефолту, кнопка "Сохранить" не будет доступна
- Выполняется проверка, все ли доступные значения формы заполнены
- Кнопка "Сохранить" будет доступна только при условии, что все доступные значения заполнены, а также значения не равны значениям по умолчанию

**Логика возвращения значений** (из ошибки 231570):
- Реализована логика возвращения значений по умолчанию при изменении значения Транзитного заказа с "Да" на "Нет"

## Реализованные доработки (из TFS)

### 1. Модификация конструктора форм (component-libs)

**Что сделано** (из Backlog Item 229881):
- Создание обработчика для правил в компоненте
- Добавление обработчика для типа

### 2. Создание библиотеки (shared-libs) для конструктора форм

**Что сделано** (из Backlog Item 229881):
- Создание фабрики правил (FormRulesFactory)
- Сервис по работе с правилами (FormRulesService)
- Модель представления зависимых полей (TreeToConstructorAdapter)

### 3. Обработка ошибок (из TFS)

**Исправленные проблемы**:
- **Ошибка 231567**: Добавлена логика на доступность кнопки "Сохранить"
- **Ошибка 231570**: Реализована логика возвращения значений по умолчанию
- **Ошибка 231484**: Добавлена фильтрация в выгрузку ХП для исключения нулевых значений

### 4. Интеграция с 1С

**Передача параметров** (из основного запроса 221894):
- Тип лицензии (оптовая/розничная)
- Выбранный магазин (для розничных магазинов)
- Префикс заказа
- Признак "Это розница"
- Дата отгрузки (минус один день от даты отгрузки товара клиенту)

## Связанные тикеты

- **221894** - Основной запрос на изменение
- **227560** - User Story: Выбор ДА
- **228037** - User Story: Редактирование атрибута после сохранения
- **229881** - Backlog Item: Погружение в доработку
- **230862** - User Story: Редактирование атрибута (JS)
- **230063** - User Story: Выбор ДА (JS)
- **231567** - Ошибка: Кнопка Сохранить
- **231570** - Ошибка: Логика возвращения значений
- **231484** - Ошибка: Лишняя строка с нулями
