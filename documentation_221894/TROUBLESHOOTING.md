# Устранение неполадок "Транзитные заказы"

## Обзор

Данный документ содержит решения наиболее частых проблем, возникающих при работе с системой "Транзитные заказы" в мобильном терминале (МТ) системы Ладога.

## Проблемы с интерфейсом

### 1. Кнопка "Сохранить" неактивна

**Симптомы**:
- Кнопка "Сохранить" в форме выбора атрибутов неактивна
- Пользователь не может сохранить выбранные значения

**Причины** (из ошибки 231567):
- Выбранные значения совпадают со значениями по умолчанию
- Не все обязательные поля заполнены
- Форма не прошла валидацию

**Решение**:
1. Проверить, что все обязательные поля заполнены
2. Изменить хотя бы одно значение от значения по умолчанию
3. Убедиться, что выбран корректный тип лицензии
4. Для "Розничная монополь" обязательно выбрать магазин

**Проверка**:
```javascript
// Проверка валидации
const validation = validateTransitOrderSelection(selectedAttributes);
if (!validation.canSave) {
    console.log('Причина:', validation.reason);
}
```

### 2. Форма не открывается

**Симптомы**:
- При выборе "Да" в поле "Транзитный заказ" форма не открывается
- Ошибка загрузки данных

**Причины**:
- Проблемы с загрузкой справочника атрибутов
- Ошибки синхронизации с Chicago
- Проблемы с локальной базой данных МТ

**Решение**:
1. Проверить подключение к серверу
2. Выполнить принудительную синхронизацию данных
3. Перезапустить мобильный терминал
4. Проверить логи ошибок

**Диагностика**:
```sql
-- Проверка данных в Chicago
SELECT COUNT(*) FROM nsf.refTransitOrdersExtendedAttributes WHERE isActive = 1;

-- Проверка данных в МТ
SELECT COUNT(*) FROM nsfrefTransitOrdersExtendedAttributes WHERE isActive = 1;
```

### 3. Неправильные значения в форме

**Симптомы**:
- Отображаются некорректные атрибуты
- Отсутствуют некоторые варианты выбора
- Неправильная иерархия атрибутов

**Причины**:
- Проблемы с синхронизацией справочника
- Устаревшие данные в локальной базе МТ
- Ошибки в конфигурации репликации

**Решение**:
1. Выполнить принудительную синхронизацию
2. Очистить кэш в МТ
3. Проверить конфигурацию Replication.Shuttle
4. Обратиться к администратору системы

## Проблемы с синхронизацией

### 1. Данные не синхронизируются

**Симптомы**:
- Изменения в Chicago не отражаются в МТ
- Справочник атрибутов не обновляется
- Ошибки в логах репликации

**Причины**:
- Остановлен сервис Replication.Shuttle
- Проблемы с сетевой связностью
- Ошибки в конфигурации репликации

**Решение**:
1. Проверить статус сервиса репликации:
   ```bash
   sc query "Replication.Shuttle.AquaTrade.UAT"
   ```

2. Перезапустить сервис:
   ```bash
   net stop "Replication.Shuttle.AquaTrade.UAT"
   net start "Replication.Shuttle.AquaTrade.UAT"
   ```

3. Проверить логи репликации:
   ```bash
   tail -f "C:\Replication\Logs\replication.log"
   ```

### 2. Медленная синхронизация

**Симптомы**:
- Синхронизация занимает много времени
- Таймауты при загрузке данных
- Низкая производительность системы

**Причины**:
- Большой объем данных для синхронизации
- Медленное сетевое соединение
- Проблемы с производительностью базы данных

**Решение**:
1. Оптимизировать запросы синхронизации
2. Увеличить интервал синхронизации
3. Проверить индексы в базе данных
4. Мониторить производительность сети

## Проблемы с интеграцией с 1С

### 1. Ошибки передачи данных в 1С

**Симптомы**:
- Заказы не передаются в 1С
- Ошибки API при передаче данных
- Некорректные данные в 1С

**Причины**:
- Недоступность API 1С
- Неправильные параметры передачи
- Ошибки валидации данных

**Решение**:
1. Проверить доступность API 1С:
   ```bash
   curl -X GET "https://1c-server.company.com/api/health"
   ```

2. Проверить логи интеграции:
   ```bash
   tail -f "C:\Logs\TransitOrders_Integration.log"
   ```

3. Валидировать данные перед передачей:
   ```json
   {
     "orderId": "12345",
     "isTransitOrder": true,
     "transitOrderData": {
       "licenseType": "Розничная ЛД",
       "prefix": "V",
       "isRetail": true
     }
   }
   ```

### 2. Таймауты API

**Симптомы**:
- Превышение времени ожидания ответа от 1С
- Ошибки "API timeout"
- Неудачные попытки передачи данных

**Причины**:
- Высокая нагрузка на сервер 1С
- Медленное сетевое соединение
- Неправильные настройки таймаута

**Решение**:
1. Увеличить таймаут API:
   ```json
   {
     "api": {
       "timeout": 60000
     }
   }
   ```

2. Реализовать повторные попытки:
   ```javascript
   const maxRetries = 3;
   let attempt = 0;
   
   while (attempt < maxRetries) {
     try {
       const result = await api.sendTo1C(data);
       break;
     } catch (error) {
       attempt++;
       if (attempt === maxRetries) throw error;
       await delay(1000 * attempt);
     }
   }
   ```

## Проблемы с базой данных

### 1. Ошибки в Chicago DB

**Симптомы**:
- Ошибки при обращении к базе данных
- Некорректные данные в справочнике
- Проблемы с производительностью

**Причины**:
- Блокировки в базе данных
- Проблемы с индексами
- Ошибки в SQL запросах

**Решение**:
1. Проверить блокировки:
   ```sql
   SELECT * FROM sys.dm_tran_locks 
   WHERE resource_database_id = DB_ID('Chicago');
   ```

2. Перестроить индексы:
   ```sql
   ALTER INDEX ALL ON nsf.refTransitOrdersExtendedAttributes REBUILD;
   ```

3. Проверить целостность данных:
   ```sql
   DBCC CHECKDB('Chicago');
   ```

### 2. Проблемы с МТ DB

**Симптомы**:
- Ошибки при работе с локальной базой
- Коррупция данных в SQLite
- Медленная работа интерфейса

**Причины**:
- Проблемы с файлом базы данных
- Недостаток места на диске
- Ошибки в SQLite

**Решение**:
1. Проверить целостность базы:
   ```sql
   PRAGMA integrity_check;
   ```

2. Очистить кэш:
   ```bash
   rm "C:\MT\Data\stmobile.db3"
   # Перезапустить МТ для пересоздания базы
   ```

3. Проверить свободное место на диске

## Диагностические команды

### Проверка системы

**Проверка статуса сервисов**:
```bash
# Replication.Shuttle
sc query "Replication.Shuttle.AquaTrade.UAT"

# Mobile Terminal
sc query "Mobile Terminal Service"
```

**Проверка логов**:
```bash
# Логи репликации
tail -f "C:\Replication\Logs\replication.log"

# Логи МТ
tail -f "C:\MT\Logs\mt.log"

# Логи интеграции
tail -f "C:\Logs\TransitOrders_Integration.log"
```

**Проверка базы данных**:
```sql
-- Chicago DB
SELECT COUNT(*) FROM nsf.refTransitOrdersExtendedAttributes WHERE isActive = 1;

-- Проверка иерархии
WITH Hierarchy AS (
    SELECT id, parentId, name, level, 0 as depth
    FROM nsf.refTransitOrdersExtendedAttributes 
    WHERE parentId IS NULL
    UNION ALL
    SELECT h.id, h.parentId, h.name, h.level, p.depth + 1
    FROM nsf.refTransitOrdersExtendedAttributes h
    INNER JOIN Hierarchy p ON h.parentId = p.id
)
SELECT * FROM Hierarchy ORDER BY depth, name;
```

### Мониторинг производительности

**Метрики для отслеживания**:
- Время синхронизации данных
- Количество ошибок в час
- Использование памяти
- Время отклика API

**Алерты**:
- Ошибки синхронизации > 5% за час
- Время отклика API > 30 секунд
- Использование памяти > 80%

## Контакты поддержки

### Эскалация проблем

1. **Уровень 1**: Проверить данное руководство
2. **Уровень 2**: Обратиться к администратору системы
3. **Уровень 3**: Создать тикет в системе поддержки

### Информация для обращения

При обращении в поддержку предоставить:
- Описание проблемы
- Скриншоты ошибок
- Логи системы
- Время возникновения проблемы
- Действия, приведшие к проблеме
