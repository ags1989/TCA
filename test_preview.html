<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест Preview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Тест отображения User Stories Preview</h2>
        
        <div id="testPreview"></div>
    </div>

    <script>
        // Тестовые данные User Stories
        const testUserStories = [
            {
                title: "Загрузка данных от AI в базу данных Чикаго",
                description: "Я, как сотрудник ЦО, хочу внедрить использование AI при работе с Чикаго, чтобы использовать результаты работы искусственного интеллекта для изменения существующих процессов, таких как формирование маршрутов агента и расчета рекомендованного заказа",
                acceptance_criteria: [{
                    html: '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;width:100%;"><tr style="background-color:#f0f0f0;"><th>Дано</th><th>Когда</th><th>Тогда</th></tr><tr><td>На стороне AI сформированы данные для передачи данных в базу данных Чикаго в установленном формате. Файл соответствует описанному формату</td><td>Срабатывает расписание загрузки данных через репликацию</td><td>Данные успешно загружены в индивидуальную таблицу</td></tr><tr><td>В базе данных Чикаго в индивидуальную таблицу загружены данные, сформированные на стороне AI</td><td>Агент в МТ совершает обмен данными (или полную загрузку)</td><td>На стороне базы данных Чикаго при формировании выгрузки для МТ из индивидуальной таблицы выбираются данные в разрезе ТТ-товар, с которыми работает агент. Данные выгружаются агенту в МТ</td></tr></table>'
                }]
            },
            {
                title: "Рек.заказ в МТ",
                description: "Я, как сотрудник ЦО, хочу чтобы агент оформлял эффективные заказы в МТ по рекомендации ИИ, чтобы повысить качество и количество продаж в ТТ",
                acceptance_criteria: [{
                    html: '<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;width:100%;"><tr style="background-color:#f0f0f0;"><th>Дано</th><th>Когда</th><th>Тогда</th></tr><tr><td>В базе данных Чикаго в индивидуальную таблицу загружены данные, сформированные на стороне AI</td><td>Агент в МТ совершает обмен данными (или полную загрузку)</td><td>На стороне базы данных Чикаго при формировании выгрузки для МТ из индивидуальной таблицы выбираются данные в разрезе ТТ-товар, с которыми работает агент. Данные выгружаются агенту в МТ</td></tr><tr><td>Агент выполнил обмен данными (или полную загрузку) в МТ. Агент начал визит в торговую точку. Агент открывает документ Заказ</td><td>Агент в настройках добавляет колонку Рек.кол. Константа «Запрещать отображение колонки с рекомендованным количеством заказа» отключена.</td><td>В колонке Рек.кол. отображается рекомендуемое количество заказа</td></tr></table>'
                }]
            }
        ];

        // Функции из app.js
        function formatUserStoryText(text) {
            if (!text) return '';
            
            // Сначала обрабатываем HTML теги и переносы строк
            let processedText = text
                .replace(/<br\s*\/?>/gi, '\n')  // Заменяем <br> на переносы строк
                .replace(/<\/p>/gi, '\n')       // Заменяем закрывающие </p> на переносы
                .replace(/<p[^>]*>/gi, '')      // Удаляем открывающие <p>
                .replace(/<[^>]*>/g, '')        // Удаляем остальные HTML теги
                .replace(/&nbsp;/g, ' ')        // Заменяем неразрывные пробелы
                .replace(/&lt;/g, '<')          // Декодируем HTML entities
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'");
            
            // Разделяем текст на части по ключевым словам
            const parts = processedText.split(/(я,?\s*как|хочу|чтобы)/i);
            let formatted = '';
            
            for (let i = 0; i < parts.length; i++) {
                const part = parts[i].trim();
                if (part.toLowerCase().match(/^я,?\s*как/i)) {
                    formatted += `<div class="mb-2"><strong>${part}</strong>`;
                } else if (part.toLowerCase() === 'хочу') {
                    formatted += ` <strong>${part}</strong>`;
                } else if (part.toLowerCase() === 'чтобы') {
                    formatted += ` <strong>${part}</strong>`;
                    if (i < parts.length - 1) {
                        formatted += ` ${parts[i + 1]}`;
                        i++; // Пропускаем следующий элемент, так как мы его уже обработали
                    }
                    formatted += `</div>`;
                } else if (part) {
                    formatted += ` ${part}`;
                }
            }
            
            // Конвертируем переносы строк в HTML
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted || processedText;
        }

        function formatAcceptanceCriteria(us) {
            // Проверяем, есть ли HTML таблица в acceptance_criteria
            if (us.acceptance_criteria && us.acceptance_criteria.length > 0) {
                const criteria = us.acceptance_criteria[0];
                
                // Проверяем, если это объект с HTML
                if (criteria && typeof criteria === 'object' && criteria.html) {
                    return `
                        <div class="mt-2">
                            ${criteria.html}
                        </div>
                    `;
                }
                
                // Проверяем, если это строка с HTML таблицей
                if (criteria && typeof criteria === 'string' && criteria.startsWith('<table')) {
                    return `
                        <div class="mt-2">
                            ${criteria}
                        </div>
                    `;
                }
                
                // Если это не HTML таблица, отображаем как обычный список
                return `
                    <ul class="mt-2">
                        ${us.acceptance_criteria.map(criteria => `<li>${criteria}</li>`).join('')}
                    </ul>
                `;
            }
            
            // Проверяем, есть ли структурированные данные Дано/Когда/Тогда
            if (us.given_conditions || us.when_actions || us.then_results) {
                return `
                    <div class="mt-2">
                        <table class="table table-bordered table-sm" style="border-collapse: collapse;">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 20%; border: 1px solid #000;">Дано</th>
                                    <th style="width: 20%; border: 1px solid #000;">Когда</th>
                                    <th style="width: 60%; border: 1px solid #000;">Тогда</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #000;">${us.given_conditions || ''}</td>
                                    <td style="border: 1px solid #000;">${us.when_actions || ''}</td>
                                    <td style="border: 1px solid #000;">${us.then_results || ''}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            return '<p class="text-muted mt-2">Критерии приемки не указаны</p>';
        }

        function formatUserStoryPreview() {
            let content = `
                <div class="mb-3">
                    <i class="fas fa-eye text-info me-2"></i>
                    <strong>Найдено ${testUserStories.length} User Stories для создания</strong>
                </div>
                <div class="mb-3 p-2 bg-info bg-opacity-10 rounded">
                    <i class="fas fa-map-marker-alt text-info me-2"></i>
                    <strong>Пространство создания:</strong><br>
                    <span class="text-muted">Команда:</span> <code>Foxtrot</code><br>
                    <span class="text-muted">Область:</span> <code>Houston\\Foxtrot</code><br>
                    <span class="text-muted">Итерация:</span> <code>Houston\\Foxtrot</code><br>
                    <span class="text-muted">Родительский тикет:</span> <code>219958</code><br>
                    <span class="text-muted">Ссылка на Wiki:</span> <a href="#" target="_blank" class="text-decoration-none"><i class="fas fa-external-link-alt me-1"></i>Открыть статью</a>
                </div>
            `;
            
            if (testUserStories && testUserStories.length > 0) {
                testUserStories.forEach((us, index) => {
                    content += `
                        <div class="mb-4 p-3 border rounded">
                            <h5 class="mb-3">${us.title}</h5>
                            <div class="mb-3">
                                ${formatUserStoryText(us.description)}
                            </div>
                            <div class="mb-3">
                                <strong>Критерии приёмки:</strong>
                                ${formatAcceptanceCriteria(us)}
                            </div>
                        </div>
                    `;
                });
            }
            
            content += `
                <div class="mt-4 p-3 bg-light rounded">
                    <strong>Для подтверждения создания отправьте:</strong> 'Да' или 'Создать'<br>
                    <strong>Для отмены отправьте:</strong> 'Нет' или 'Отмена'
                </div>
            `;
            
            return content;
        }

        // Отображаем preview
        document.getElementById('testPreview').innerHTML = formatUserStoryPreview();
    </script>
</body>
</html>
